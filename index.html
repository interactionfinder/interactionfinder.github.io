<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Interaction Finder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #007bff; --primary-hover-color: #0056b3; --secondary-color: #6c757d;
      --secondary-hover-color: #545b62; --success-color: #28a745; --danger-color: #dc3545;
      --highlight-drug-bg: #e6f7ff; --highlight-drug-text: #005f8d; /* Light blue */
      --highlight-importance-high-bg: #ffe6e6; --highlight-importance-high-text: #c00; /* Light red */
      --highlight-importance-medium-bg: #fff0e6; --highlight-importance-medium-text: #c50; /* Light orange */
      --highlight-importance-low-bg: #e6ffe6; --highlight-importance-low-text: #070; /* Light green */
      --light-bg: #f8f9fa; --card-bg: #ffffff; --text-color: #333; --border-color: #dee2e6;
      --border-radius: 0.5rem; --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --font-family: 'Poppins', system-ui, sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font-family); background-color: var(--light-bg); color: var(--text-color);
      display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 1.5rem 1rem;
    }
    #apiKeyConfigArea {
      background-color: var(--card-bg); padding: 1rem 1.25rem; border-radius: var(--border-radius);
      box-shadow: var(--box-shadow); margin-bottom: 1.5rem; width: 100%; max-width: 700px;
    }
    #apiKeyConfigArea h3 { margin-top: 0; margin-bottom: 0.75rem; font-size: 1.15rem; }
    .api-key-form-group { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
    #apiKeyConfigArea label { font-weight: 500; flex-shrink: 0; font-size: 0.9rem; }
    #apiKeyConfigArea input[type="password"] {
      flex-grow: 1; padding: 0.5rem 0.75rem; border: 1px solid var(--border-color);
      border-radius: var(--border-radius); font-size: 0.9rem; min-width: 180px;
    }
    #apiKeyConfigArea input[type="password"]:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
    #apiKeyConfigArea .api-key-buttons button { padding: 0.5rem 0.9rem; font-size: 0.85rem; margin-right: 0.4rem; }
    #apiKeyConfigArea .api-key-buttons button.test-key { background-color: var(--success-color); }
    #apiKeyConfigArea .api-key-buttons button.test-key:hover { background-color: #1e7e34; }
    #apiKeyStatus { font-size: 0.85rem; min-height: 1.2em; margin-top: 0.4rem; font-weight: 500; }
    #apiKeyStatus.success { color: var(--success-color); } #apiKeyStatus.error { color: var(--danger-color); } #apiKeyStatus.info { color: var(--secondary-color); }

    .page-container { width: 100%; max-width: 700px; display: flex; flex-direction: column; gap: 1.5rem; }
    section {
      background-color: var(--card-bg); padding: 1.25rem 1.5rem; border-radius: var(--border-radius);
      box-shadow: var(--box-shadow); width: 100%;
    }
    button {
      padding: 0.7rem 1.4rem; font-size: 0.95rem; font-weight: 500; border: none;
      border-radius: var(--border-radius); cursor: pointer; background: var(--primary-color);
      color: #fff; transition: background-color 0.2s ease-in-out, transform 0.1s ease;
    }
    button:hover { background: var(--primary-hover-color); transform: translateY(-1px); }
    button.secondary { background-color: var(--secondary-color); }
    button.secondary:hover { background-color: var(--secondary-hover-color); }
    button.danger { background-color: var(--danger-color); }
    button.danger:hover { background-color: #c82333; }


    img#previewImg { max-width: 100%; height: auto; border-radius: var(--border-radius); box-shadow: 0 2px 6px rgba(0,0,0,.1); margin-top: 1rem; margin-bottom: 1.5rem; display: block; }
    [hidden] { display: none !important; }
    .spinner { width: 40px; height: 40px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 1.5rem auto; }
    @keyframes spin { to { transform: rotate(360deg); } }

    #responseBox {
      width: 100%; min-height: 180px; max-height: 450px; overflow-y: auto; padding: 1rem;
      border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.95rem;
      background-color: #fdfdfd; line-height: 1.6; white-space: pre-wrap;
    }
    #responseBox h3 { /* Modified for copy button */
        font-size: 1.15em; margin-top: 1em; margin-bottom: 0.5em; color: var(--primary-color);
        display: flex; align-items: center; justify-content: space-between;
    }
    #responseBox h3 .section-title-text { flex-grow: 1; } /* Span to hold the title text */
    .copy-section-btn {
        background: none; border: 1px solid var(--border-color); color: var(--secondary-color);
        padding: 0.2em 0.4em; font-size: 0.75em; border-radius: 0.25rem; cursor: pointer;
        margin-left: 0.5em; opacity: 0.7; transition: opacity 0.2s, background-color 0.2s;
        flex-shrink: 0; /* Prevent button from shrinking */
    }
    .copy-section-btn:hover { opacity: 1; background-color: var(--light-bg); color: var(--primary-color); }

    #responseBox ul { list-style-type: disc; margin-left: 1.5em; margin-bottom: 1em; padding-left: 0;}
    #responseBox li { margin-bottom: 0.3em; }
    #responseBox strong { font-weight: 600; }
    #responseBox p { margin-bottom: 0.8em; }
    .highlight-drug { background-color:var(--highlight-drug-bg); color:var(--highlight-drug-text); padding:0.1em 0.3em; border-radius:0.2em; font-weight:500; }
    .highlight-importance-high { background-color:var(--highlight-importance-high-bg); color:var(--highlight-importance-high-text); padding:0.1em 0.3em; border-radius:0.2em; font-weight:bold; }
    .highlight-importance-medium { background-color:var(--highlight-importance-medium-bg); color:var(--highlight-importance-medium-text); padding:0.1em 0.3em; border-radius:0.2em; font-weight:500; }
    .highlight-importance-low { background-color:var(--highlight-importance-low-bg); color:var(--highlight-importance-low-text); padding:0.1em 0.3em; border-radius:0.2em; font-weight:500; }


    select, textarea#promptEditor {
      width: 100%; padding: 0.6rem 0.9rem; border: 1px solid var(--border-color);
      border-radius: var(--border-radius); font-size: 0.95rem; background-color: #fff; color: var(--text-color);
      font-family: var(--font-family);
    }
    textarea#promptEditor {
        min-height: 250px; resize: vertical; margin-bottom: 1rem;
    }
    textarea#promptEditor:focus, select:focus {
        outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }


    h1, h2 { font-weight: 600; color: var(--text-color); margin-bottom: 0.75rem; }
    h1 { font-size: 1.6rem; } h2 { font-size: 1.3rem; }
    #captureSection > h2, #historySection > .history-header > h2, #promptSection > h2 { text-align: center; }


    #mainHeader {
      display: flex; align-items: center; gap: 0.8rem; margin-bottom: 1rem; width: 100%; max-width: 700px;
    }
    #mainHeader img { width: 40px; height: 40px; border-radius: 50%; }
    #mainHeader h1 { margin: 0; }

    #loadingSection { text-align: center; }
    #loadingSection p { margin-top: 0.5rem; font-size: 1rem; color: var(--secondary-color); }
    #previewSection .button-group { display: flex; flex-direction: column; gap: 0.6rem; margin-top: 1.2rem; }
    #previewSection select { margin-bottom: 0.6rem; }
    
    #resultSection { display: flex; flex-direction: column; }
    .result-actions {
        display: flex; justify-content: center; align-items: center;
        margin-top: 1.5rem; gap: 1rem; width: 100%;
    }
    .result-actions button { flex-grow: 0; min-width: 120px; }
    @media (max-width: 480px) {
        .result-actions { flex-direction: column; align-items: stretch; }
        .result-actions button { width: 100%; }
    }

    .history-header {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;
    }
    .history-header h2 { margin-bottom: 0; flex-grow: 1; text-align: center;}
    #clearAllHistoryBtn { font-size: 0.8rem; padding: 0.4rem 0.8rem; flex-shrink: 0; }

    #historyCarouselContainer { overflow-x: auto; white-space: nowrap; padding-bottom: 1rem; margin-bottom: -1rem; }
    #historyCarousel { display: flex; gap: 0.75rem; }
    .history-item-wrapper {
        display: flex; flex-direction: column; align-items: center;
        text-decoration: none; color: var(--text-color); width: 110px; position: relative;
    }
    .history-item {
        width: 100px; height: 100px; border: 2px solid var(--border-color);
        border-radius: var(--border-radius); overflow: hidden; cursor: pointer;
        transition: border-color 0.2s ease, transform 0.2s ease; margin-bottom: 0.25rem; position: relative;
    }
    .history-item:hover { border-color: var(--primary-color); transform: translateY(-2px); }
    .history-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .history-item-date {
        font-size: 0.75rem; color: var(--secondary-color); text-align: center;
        display: block; white-space: normal; line-height: 1.2; width: 100%;
    }
    .delete-history-item-btn {
        position: absolute; top: 3px; right: 3px; background-color: rgba(0,0,0,0.4); color: white;
        border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; font-weight: bold;
        line-height: 20px; text-align: center; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        opacity: 0; transition: opacity 0.2s ease, background-color 0.2s ease; z-index: 10;
    }
    .history-item-wrapper:hover .delete-history-item-btn { opacity: 1; }
    .delete-history-item-btn:hover { background-color: var(--danger-color); }
    #noHistoryMessage { color: var(--secondary-color); font-style: italic; text-align: center; padding: 1rem 0;}

    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6);
        display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0;
        visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s linear;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0s 0s linear; }
    .modal-content {
        background-color: var(--card-bg); padding: 1.5rem 2rem; border-radius: var(--border-radius);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 450px; text-align: center;
        transform: scale(0.95); transition: transform 0.3s ease;
    }
    .modal-overlay.active .modal-content { transform: scale(1); }
    .modal-content p { margin-bottom: 1.5rem; font-size: 1.05rem; line-height: 1.5; }
    .modal-buttons { display: flex; justify-content: center; gap: 1rem; }
    .modal-buttons button { padding: 0.6rem 1.2rem; font-size: 0.9rem; }

    #promptCustomizationBtnContainer {
        text-align: center; margin-top: 0;
    }
    #promptSection .prompt-actions {
        display: flex; justify-content: space-around; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;
    }
     #promptSection .prompt-actions button { flex-grow: 1; min-width: 150px; }
    #promptStatus {
        font-size: 0.9rem; min-height: 1.3em; margin-top: 1rem; font-weight: 500; text-align: center;
    }
    #promptStatus.success { color: var(--success-color); }
    #promptStatus.info { color: var(--secondary-color); }
  </style>
</head>
<body>

  <header id="mainHeader">
    <img src="https://www.citypng.com/public/uploads/preview/black-circle-round-question-mark-icon-png-70175169496360405wfyhabkn.png" alt="Logo">
    <h1>Interaction Finder</h1>
  </header>

  <div id="apiKeyConfigArea">
    <h3>API Key Configuration</h3>
    <div class="api-key-form-group">
      <label for="apiKeyInput">OpenAI API Key:</label>
      <input type="password" id="apiKeyInput" placeholder="Enter your OpenAI API Key">
    </div>
    <div class="api-key-buttons">
      <button id="saveApiKeyBtn">Save</button>
      <button id="testApiKeyBtn" class="test-key">Test</button>
      <button id="clearApiKeyBtn" class="secondary">Clear</button>
    </div>
    <p id="apiKeyStatus" class="info"></p>
  </div>

  <div class="page-container">
    <section id="captureSection">
      <h2>Take a Photo</h2>
      <p style="margin-bottom: 1.2rem; color: #555; font-size: 0.9rem; text-align: center;">
        Upload an image of the prescription to analyze.
      </p>
      <div style="text-align:center;">
        <button id="takePhotoBtn">Take Photo or Upload</button>
      </div>
      <input id="fileInput" type="file" accept="image/*" capture="environment" hidden>
    </section>

    <section id="historySection" hidden>
        <div class="history-header">
            <h2>Recent Analyses</h2>
            <button id="clearAllHistoryBtn" class="danger">Clear All</button>
        </div>
        <div id="historyCarouselContainer"> <div id="historyCarousel"></div> </div>
        <p id="noHistoryMessage" hidden>No recent analyses found.</p>
    </section>

    <div id="promptCustomizationBtnContainer" hidden>
        <button id="goToPromptCustomizationBtn" class="secondary">Prompt Customization</button>
    </div>

    <section id="previewSection" hidden>
      <h2>Confirm Prescription Image</h2>
      <img id="previewImg" alt="preview">
      <div class="button-group">
        <p style="margin-bottom: 0.5rem; text-align: center; font-size:0.9rem;">Select AI Model:</p>
        <select id="modelSelect">
          <option value="gpt-4o-mini">GPT-4o-mini (Faster, Good)</option>
          <option value="gpt-4o">GPT-4o (Slower, Best)</option>
        </select>
        <button id="usePhotoBtn">Use This Photo & Analyze</button>
        <button id="retakeBtn" class="secondary">Retake or Choose Different</button>
      </div>
    </section>

    <section id="loadingSection" hidden>
      <div class="spinner"></div>
      <p>Analyzing image, please wait…</p>
    </section>

    <section id="resultSection" hidden>
      <h2>Analysis Results</h2>
      <div id="responseBox" role="document" aria-live="polite"></div>
      <div class="result-actions">
        <button id="copyResultsBtn">Copy Results</button>
        <button id="restartBtn" class="secondary">Back to Start</button>
      </div>
    </section>

    <section id="promptSection" hidden>
        <h2>Customize System Prompt</h2>
        <p style="font-size:0.85rem; color: var(--secondary-color); margin-bottom:1rem;">
            Modify the instructions given to the AI. Be careful, as significant changes can affect results.
        </p>
        <textarea id="promptEditor" rows="10"></textarea>
        <div class="prompt-actions">
            <button id="savePromptBtn">Save Prompt</button>
            <button id="resetPromptBtn" class="secondary">Reset to Default</button>
            <button id="returnToMainBtn" class="secondary">Return to Main</button>
        </div>
        <p id="promptStatus"></p>
    </section>
  </div>

  <div id="customModalOverlay" class="modal-overlay">
    <div class="modal-content">
      <p id="modalMessage">Are you sure?</p>
      <div class="modal-buttons">
        <button id="modalConfirmBtn" class="danger">Confirm</button>
        <button id="modalCancelBtn" class="secondary">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const MAX_HISTORY_ITEMS = 7;
    const HISTORY_STORAGE_KEY = 'interactionFinderHistory';
    const CUSTOM_PROMPT_STORAGE_KEY = 'interactionFinderCustomPrompt';
    const DEFAULT_SYSTEM_PROMPT = `You are a hospital pharmacist analyzing a prescription image.
Format your response strictly using Markdown:
1.  Start with a heading: '### Detected Medications'
    *   Under this, use a bulleted list (*). For each drug, use the format: * DRUG{Drug Name} Dosage (e.g., * DRUG{Amoxicillin} 250mg three times daily).
2.  Next heading: '### Interactions Found'
    *   Bulleted list of any drug-drug interactions identified. If none, state "No significant interactions found." For each interaction pair, use DRUG{} for each drug. e.g. * DRUG{Warfarin} and DRUG{Aspirin}.
3.  Next heading: '### Consequences & Importance'
    *   For each interaction, explain its consequences and rate its importance/danger using IMPORTANCE{Severity} (e.g., IMPORTANCE{High}, IMPORTANCE{Medium}, IMPORTANCE{Low}).
4.  Final heading: '### Recommendations'
    *   Provide clear, actionable recommendations.

Your primary task is to clearly state the drugs and dosages, then identify and report interactions, their consequences, importance, and your recommendations. Keep it concise.
If your view of the prescription is obstructed or unreadable, state this first under a heading '### Readability Issues'.
Do not include disclaimers, refuse to answer, or suggest consulting external resources unless absolutely critical for immediate patient safety.`;

    function sel(id){ return document.getElementById(id); }
    const apiKeyInput = sel('apiKeyInput'), saveApiKeyBtn = sel('saveApiKeyBtn'),
          testApiKeyBtn = sel('testApiKeyBtn'), clearApiKeyBtn = sel('clearApiKeyBtn'),
          apiKeyStatus = sel('apiKeyStatus');
    const takePhotoBtn=sel('takePhotoBtn'), fileInput  =sel('fileInput'),
          previewImg =sel('previewImg'), usePhotoBtn=sel('usePhotoBtn'),
          retakeBtn  =sel('retakeBtn'), modelSelect=sel('modelSelect'),
          loadingSec = sel('loadingSection'), responseBox  =sel('responseBox'),
          restartBtn =sel('restartBtn'), copyResultsBtn = sel('copyResultsBtn');
    const historyCarousel = sel('historyCarousel'), noHistoryMessage = sel('noHistoryMessage'),
          historySectionElement = sel('historySection'),
          historyCarouselContainer = sel('historyCarouselContainer'),
          clearAllHistoryBtn = sel('clearAllHistoryBtn');
    const customModalOverlay = sel('customModalOverlay'), modalMessage = sel('modalMessage'),
          modalConfirmBtn = sel('modalConfirmBtn'), modalCancelBtn = sel('modalCancelBtn');
    const goToPromptCustomizationBtn = sel('goToPromptCustomizationBtn'),
          promptCustomizationBtnContainer = sel('promptCustomizationBtnContainer'),
          promptSectionElement = sel('promptSection'), promptEditor = sel('promptEditor'),
          savePromptBtn = sel('savePromptBtn'), resetPromptBtn = sel('resetPromptBtn'),
          returnToMainBtn = sel('returnToMainBtn'), promptStatus = sel('promptStatus');

    let appApiKey = '';
    let base64Image='';
    let analysisHistory = [];
    let currentSystemPrompt = DEFAULT_SYSTEM_PROMPT;
    let currentConfirmCallback = null;

    const showEl=el=>el.hidden=false;
    const hideEl=el=>el.hidden=true;
    const allPageElementsToToggle = Array.from(document.querySelector('.page-container').querySelectorAll('section, div#promptCustomizationBtnContainer'));


    function switchTo(targetSectionId){
      allPageElementsToToggle.forEach(el => hideEl(el));

      const sectionToShow = sel(targetSectionId);
      if (sectionToShow) showEl(sectionToShow);

      if (targetSectionId === 'captureSection') {
        showEl(historySectionElement);
        showEl(promptCustomizationBtnContainer);
        if (analysisHistory.length > 0) {
            hideEl(noHistoryMessage); showEl(historyCarouselContainer); showEl(clearAllHistoryBtn);
        } else {
            showEl(noHistoryMessage); hideEl(historyCarouselContainer); hideEl(clearAllHistoryBtn);
        }
      }
    }
    
    function updateStatusWithMessage(element, message, type = 'info', duration = 4000) {
        element.textContent = message; element.className = type;
        if (message && duration > 0) { setTimeout(() => { if (element.textContent === message) { element.textContent = ''; element.className = 'info';}}, duration); }
    }
    function updateApiKeyStatus(message, type = 'info') { updateStatusWithMessage(apiKeyStatus, message, type); }
    function updatePromptStatus(message, type = 'info') { updateStatusWithMessage(promptStatus, message, type); }

    function loadApiKeyFromStorage() {
      const k=localStorage.getItem('interactionFinderApiKey'); if(k){apiKeyInput.value=k;appApiKey=k;updateApiKeyStatus('API Key loaded.','info');}else{updateApiKeyStatus('Please enter API Key.','info');}
    }
    saveApiKeyBtn.onclick = () => {
      const k=apiKeyInput.value.trim();if(k&&k.startsWith('sk-')){localStorage.setItem('interactionFinderApiKey',k);appApiKey=k;updateApiKeyStatus('API Key saved!','success');}else{updateApiKeyStatus(k?'Invalid Key format.':'Key cannot be empty.','error');}
    };
    testApiKeyBtn.onclick = async () => {
      const k=apiKeyInput.value.trim();if(!k){updateApiKeyStatus('Enter key to test.','error');return;} updateApiKeyStatus('Testing...','info');try{const r=await fetch('https://api.openai.com/v1/models',{headers:{'Authorization':`Bearer ${k}`}});if(r.ok){updateApiKeyStatus('Key valid!','success');if(k!==appApiKey){localStorage.setItem('interactionFinderApiKey',k);appApiKey=k;}}else{const e=await r.json();updateApiKeyStatus(`Test failed: ${e.error?.message||r.statusText}`,'error');}}catch(e){updateApiKeyStatus('Test failed: Network error.','error');}
    };
    clearApiKeyBtn.onclick = () => {
      localStorage.removeItem('interactionFinderApiKey');apiKeyInput.value='';appApiKey='';updateApiKeyStatus('API Key cleared.','info');
    };

    function showCustomConfirm(message, onConfirm) {
        modalMessage.textContent = message; currentConfirmCallback = onConfirm; customModalOverlay.classList.add('active');
    }
    function hideCustomConfirm() {
        customModalOverlay.classList.remove('active'); currentConfirmCallback = null;
    }
    modalConfirmBtn.onclick = () => { if (currentConfirmCallback) currentConfirmCallback(); hideCustomConfirm(); };
    modalCancelBtn.onclick = hideCustomConfirm;
    customModalOverlay.onclick = (e) => { if (e.target === customModalOverlay) hideCustomConfirm(); };

    function loadHistory() {
        const storedHistory = localStorage.getItem(HISTORY_STORAGE_KEY);
        try { analysisHistory = storedHistory ? JSON.parse(storedHistory) : []; }
        catch (e) { analysisHistory = []; localStorage.removeItem(HISTORY_STORAGE_KEY); }
        renderHistoryCarousel();
    }
    function saveAnalysisToHistory(imgBase64, respHtml, model) { // respHtml should be the final HTML with highlights
        const newHistoryItem = { id: Date.now(), imageBase64: imgBase64, responseHtml: respHtml, modelUsed: model, timestamp: Date.now() };
        analysisHistory.unshift(newHistoryItem);
        if (analysisHistory.length > MAX_HISTORY_ITEMS) analysisHistory.length = MAX_HISTORY_ITEMS;
        localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(analysisHistory));
        renderHistoryCarousel();
    }
    function deleteHistoryItem(itemId) {
        showCustomConfirm('Delete this analysis from history?', () => {
            analysisHistory = analysisHistory.filter(item => item.id !== itemId);
            localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(analysisHistory));
            renderHistoryCarousel();
        });
    }
    clearAllHistoryBtn.onclick = () => {
        showCustomConfirm('Clear all recent analyses? This cannot be undone.', () => {
            analysisHistory = [];
            localStorage.removeItem(HISTORY_STORAGE_KEY);
            renderHistoryCarousel();
        });
    };
    function renderHistoryCarousel() {
        historyCarousel.innerHTML = '';
        if (analysisHistory.length === 0) {
            showEl(noHistoryMessage); hideEl(historyCarouselContainer); hideEl(clearAllHistoryBtn);
        } else {
            hideEl(noHistoryMessage); showEl(historyCarouselContainer); showEl(clearAllHistoryBtn);
            analysisHistory.forEach(item => {
                const wrapper = document.createElement('div'); wrapper.className = 'history-item-wrapper';
                const itemDiv = document.createElement('div'); itemDiv.className = 'history-item';
                itemDiv.addEventListener('click', () => loadAnalysisFromHistoryItem(item));
                const img = document.createElement('img'); img.src = `data:image/jpeg;base64,${item.imageBase64}`;
                img.alt = `Analyzed prescription ${new Date(item.timestamp).toLocaleDateString()}`;
                itemDiv.appendChild(img);
                const delBtn = document.createElement('button'); delBtn.className = 'delete-history-item-btn';
                delBtn.innerHTML = '×'; delBtn.title = 'Delete this analysis';
                delBtn.onclick = (e) => { e.stopPropagation(); deleteHistoryItem(item.id); };
                itemDiv.appendChild(delBtn);
                const dateSpan = document.createElement('span'); dateSpan.className = 'history-item-date';
                const d = new Date(item.timestamp); const h = String(d.getHours()).padStart(2,'0'); const m = String(d.getMinutes()).padStart(2,'0');
                dateSpan.textContent = `${d.getMonth()+1}/${d.getDate()}/${String(d.getFullYear()).slice(-2)} ${h}:${m}`;
                wrapper.appendChild(itemDiv); wrapper.appendChild(dateSpan); historyCarousel.appendChild(wrapper);
            });
        }
    }
    function loadAnalysisFromHistoryItem(historyItem) {
        if(historyItem){
            responseBox.innerHTML=historyItem.responseHtml; // This HTML should already have highlights and copy buttons
            // No need to call addCopySectionButtons() here if history items store the fully rendered HTML
            switchTo('resultSection');
        }
    }

    function loadCustomPrompt() {
        const storedPrompt = localStorage.getItem(CUSTOM_PROMPT_STORAGE_KEY);
        currentSystemPrompt = storedPrompt ? storedPrompt : DEFAULT_SYSTEM_PROMPT;
        promptEditor.value = currentSystemPrompt;
        if(storedPrompt) updatePromptStatus('Custom prompt loaded.','info', 2000);
    }
    goToPromptCustomizationBtn.onclick = () => {
        promptEditor.value = currentSystemPrompt; switchTo('promptSection');
    };
    savePromptBtn.onclick = () => {
        const newPrompt = promptEditor.value.trim();
        if (newPrompt) {
            currentSystemPrompt = newPrompt; localStorage.setItem(CUSTOM_PROMPT_STORAGE_KEY, newPrompt);
            updatePromptStatus('Prompt saved successfully!', 'success');
        } else {
            updatePromptStatus('Prompt cannot be empty. Reverted.', 'error');
            promptEditor.value = currentSystemPrompt;
        }
    };
    resetPromptBtn.onclick = () => {
        showCustomConfirm("Reset prompt to its original default version?", () => {
            currentSystemPrompt = DEFAULT_SYSTEM_PROMPT; promptEditor.value = DEFAULT_SYSTEM_PROMPT;
            localStorage.removeItem(CUSTOM_PROMPT_STORAGE_KEY);
            updatePromptStatus('Prompt reset to default.', 'info');
        });
    };
    returnToMainBtn.onclick = () => switchTo('captureSection');

    takePhotoBtn.onclick =()=>fileInput.click();
    retakeBtn.onclick    =()=>fileInput.click();
    fileInput.onchange   = async () => {
      const f=fileInput.files[0];if(!f)return;try{base64Image=await toBase64(f);previewImg.src='data:image/jpeg;base64,'+base64Image;switchTo('previewSection');}catch(e){console.error("File error:",e);alert("Could not load image.");}
    };
    usePhotoBtn.onclick=()=>analyzeImage();
    restartBtn.onclick=()=> {
      responseBox.innerHTML='';fileInput.value='';base64Image='';previewImg.src='';modelSelect.value='gpt-4o-mini';switchTo('captureSection');
    };
    copyResultsBtn.onclick = () => {
      const t=responseBox.textContent;if(navigator.clipboard&&t){navigator.clipboard.writeText(t).then(()=>updateApiKeyStatus('Results copied to clipboard!','success', 2000)).catch(e=>updateApiKeyStatus('Failed to copy results.','error', 2000));}
    };

    function markdownToHtml(mdText) {
        let html = mdText;
        html = html.replace(/&/g, '&').replace(/</g, '<').replace(/>/g, '>');
        html = html.replace(/DRUG\{(.*?)\}/gim, '<span class="highlight-drug">$1</span>');
        html = html.replace(/IMPORTANCE\{(High|Medium|Low)\}/gim, (match, severity) => {
            return `<span class="highlight-importance-${severity.toLowerCase()}">${severity}</span>`;
        });
        html = html.replace(/^### (.*$)/gim, '<h3><span class="section-title-text">$1</span></h3>'); // Added specific class for title text
        html = html.replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>');
        html = html.replace(/__(.*?)__/gim, '<strong>$1</strong>');
        html = html.replace(/\*(.*?)\*/gim, '<em>$1</em>');
        html = html.replace(/_(.*?)_/gim, '<em>$1</em>');
        let inList = false;
        html = html.split('\n').map(line => {
            const trimmedLine = line.trim();
            if (trimmedLine.match(/^[\*\-] /)) {
                let listItemContent = trimmedLine.substring(trimmedLine.indexOf(' ') + 1).trim();
                let listItem = `<li>${listItemContent}</li>`;
                if (!inList) { inList = true; return `<ul>${listItem}`; }
                return listItem;
            } else {
                if (inList) { inList = false; return `</ul>${line}`; } // Keep original line after closing ul
                return line; // Keep original line if not list item
            }
        }).join('\n');
        if (inList) html += '</ul>';
        
        html = html.replace(/^\s*$/gm, ''); // Remove empty lines that were just spaces
        html = html.split(/\n\n+/g) // Split by double (or more) newlines for paragraphs
            .map(paragraph => {
                const trimmedP = paragraph.trim();
                if (!trimmedP) return '';
                if (trimmedP.startsWith('<ul>') || trimmedP.startsWith('<h3>') || trimmedP.endsWith('</ul>')) {
                    return paragraph; // Return as is if it's already structured
                }
                // For lines that are not part of lists or headings, wrap in <p>
                // This handles cases where AI might not use double newlines but single ones for paragraphs
                return trimmedP.split('\n').map(line => line.trim() ? `<p>${line.trim()}</p>` : '').join('');
            })
            .join('');
        return html.trim();
    }

    function addCopySectionButtonsToResponseBox() {
        const headers = responseBox.querySelectorAll('h3'); // Target H3 directly
        headers.forEach(headerElement => {
            // Ensure the title text is wrapped in a span if not already
            let titleSpan = headerElement.querySelector('.section-title-text');
            if (!titleSpan) {
                const titleText = headerElement.textContent;
                headerElement.innerHTML = ''; // Clear h3
                titleSpan = document.createElement('span');
                titleSpan.className = 'section-title-text';
                titleSpan.textContent = titleText;
                headerElement.appendChild(titleSpan);
            }

            if (headerElement.querySelector('.copy-section-btn')) return; // Skip if button exists

            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-section-btn';
            copyBtn.textContent = 'Copy'; // Shorter text
            copyBtn.title = `Copy "${titleSpan.textContent}" section`;
            headerElement.appendChild(copyBtn);
        });
    }

    responseBox.addEventListener('click', function(event) {
        if (event.target.classList.contains('copy-section-btn')) {
            const headerElement = event.target.closest('h3');
            if (!headerElement) return;

            let contentToCopy = headerElement.querySelector('.section-title-text').textContent + '\n';
            let nextElement = headerElement.nextElementSibling;
            
            while (nextElement && nextElement.tagName !== 'H3') {
                if (nextElement.tagName === 'UL') {
                    Array.from(nextElement.querySelectorAll('li')).forEach(li => {
                        contentToCopy += `• ${li.textContent.trim()}\n`;
                    });
                } else {
                    contentToCopy += nextElement.textContent.trim() + '\n';
                }
                nextElement = nextElement.nextElementSibling;
            }
            if (navigator.clipboard) {
                navigator.clipboard.writeText(contentToCopy.trim())
                    .then(() => updateApiKeyStatus('Section copied!', 'success', 2000))
                    .catch(err => updateApiKeyStatus('Failed to copy section.', 'error', 2000));
            }
        }
    });
	
    async function analyzeImage(){
      if(!appApiKey){updateApiKeyStatus('API Key required.','error');apiKeyInput.focus();if(!loadingSec.hidden)switchTo('previewSection');responseBox.innerHTML='<p style="color:var(--danger-color);">API Key missing.</p>';return;}
      responseBox.innerHTML='';switchTo('loadingSection');
      const selectedModel=modelSelect.value;
      const body={model:selectedModel,messages:[{role:'user',content:[{type:'text',text:currentSystemPrompt},{type:'image_url',image_url:{url:'data:image/jpeg;base64,'+base64Image}}]}],max_tokens:2000};
      try{
        const rs=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+appApiKey},body:JSON.stringify(body)});
        const d=await rs.json();
        if(rs.ok&&d.choices?.[0]?.message?.content){
            const rm=d.choices[0].message.content.trim();
            const hr=markdownToHtml(rm); // Convert MD to HTML with highlights
            responseBox.innerHTML=hr;
            addCopySectionButtonsToResponseBox(); // Add copy buttons to the now rendered HTML
            saveAnalysisToHistory(base64Image, responseBox.innerHTML, selectedModel); // Save final HTML with buttons for history
        }else{
            const em=d.error?`${d.error.message} (Code: ${d.error.code})`:'Unknown API error.';
            responseBox.innerHTML=`<p style="color:var(--danger-color);">Error: ${em}</p>`;
            if(d.error?.code==='invalid_api_key'||d.error?.type==='auth_error'){updateApiKeyStatus('Invalid API Key.','error');appApiKey='';localStorage.removeItem('interactionFinderApiKey');apiKeyInput.value='';}
        }
    }catch(e){responseBox.innerHTML='<p style="color:var(--danger-color);">Request failed. Check network.</p>';}
    finally{switchTo('resultSection');}
    }
    function toBase64(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result.split(',')[1]);r.onerror=rej;r.readAsDataURL(file);});}

    loadApiKeyFromStorage();
    loadHistory();
    loadCustomPrompt();
    switchTo('captureSection');
  </script>
</body>
</html>