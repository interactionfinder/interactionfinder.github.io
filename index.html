<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interaction Finder & Medication Advice</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
          --primary-color: #007bff; --primary-hover-color: #0056b3; --secondary-color: #6c757d;
          --secondary-hover-color: #545b62; --success-color: #28a745; --danger-color: #dc3545;
          --purple-color: #6f42c1; --purple-hover-color: #5a32a3;
          --highlight-drug-bg: #e6f7ff; --highlight-drug-text: #005f8d;
          --highlight-importance-high-bg: #ffe6e6; --highlight-importance-high-text: #c00;
          --highlight-importance-medium-bg: #fff0e6; --highlight-importance-medium-text: #c50;
          --highlight-importance-low-bg: #e6ffe6; --highlight-importance-low-text: #070;
          --light-bg: #f8f9fa; --card-bg: #ffffff; --text-color: #333; --border-color: #dee2e6;
          --border-radius: 0.5rem; --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
          --font-family: 'Poppins', system-ui, sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
          font-family: var(--font-family); background-color: var(--light-bg); color: var(--text-color);
          display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 1.5rem 1rem;
        }
        
        /* --- SHARED STYLES (API Key, Headers, Buttons, Cards) --- */
        .app-container {
            width: 100%; max-width: 700px; display: flex; 
            flex-direction: column; gap: 1.5rem; margin-top: 1.5rem;
        }
        #appHeader {
          display: flex; align-items: center; gap: 0.8rem; margin-bottom: 1rem; width: 100%; max-width: 700px;
        }
        #appHeader img { width: 40px; height: 40px; border-radius: 50%; }
        #appHeader h1 { margin: 0; font-size: 1.6rem; color: var(--text-color); font-weight: 600;}

        #apiKeyConfigArea {
          background-color: var(--card-bg); padding: 1rem 1.25rem; border-radius: var(--border-radius);
          box-shadow: var(--box-shadow); width: 100%; max-width: 700px;
        }
        #apiKeyConfigArea h3 { margin-top: 0; margin-bottom: 0.75rem; font-size: 1.15rem; color: var(--text-color);}
        .api-key-form-group { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        #apiKeyConfigArea label { font-weight: 500; flex-shrink: 0; font-size: 0.9rem; color: var(--text-color);}
        #apiKeyConfigArea input[type="password"] {
          flex-grow: 1; padding: 0.5rem 0.75rem; border: 1px solid var(--border-color);
          border-radius: var(--border-radius); font-size: 0.9rem; min-width: 180px;
          font-family: var(--font-family); color: var(--text-color);
        }
        #apiKeyConfigArea input[type="password"]:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
        #apiKeyConfigArea .api-key-buttons button { padding: 0.5rem 0.9rem; font-size: 0.85rem; margin-right: 0.4rem; }
        #apiKeyConfigArea .api-key-buttons button:last-child { margin-right: 0; }
        #apiKeyConfigArea .api-key-buttons button.test-key { background-color: var(--success-color); }
        #apiKeyConfigArea .api-key-buttons button.test-key:hover { background-color: #1e7e34; }
        #apiKeyStatus { font-size: 0.85rem; min-height: 1.2em; margin-top: 0.4rem; font-weight: 500; }
        #apiKeyStatus.success { color: var(--success-color); } 
        #apiKeyStatus.error { color: var(--danger-color); } 
        #apiKeyStatus.info { color: var(--secondary-color); }

        button {
          padding: 0.7rem 1.4rem; font-size: 0.95rem; font-weight: 500; border: none;
          border-radius: var(--border-radius); cursor: pointer; background: var(--primary-color);
          color: #fff; transition: background-color 0.2s ease-in-out, transform 0.1s ease;
          font-family: var(--font-family);
        }
        button:hover { background: var(--primary-hover-color); transform: translateY(-1px); }
        button.secondary { background-color: var(--secondary-color); }
        button.secondary:hover { background-color: var(--secondary-hover-color); }
        button.danger { background-color: var(--danger-color); }
        button.danger:hover { background-color: #c82333; }
        button.purple { background-color: var(--purple-color); }
        button.purple:hover { background-color: var(--purple-hover-color); }
        button.green { background-color: var(--success-color); }
        button.green:hover { background-color: #1e7e34; }
        button:disabled { background-color: var(--secondary-color); opacity: 0.7; cursor: not-allowed; transform: translateY(0); }

        .view-section {
          background-color: var(--card-bg); padding: 1.25rem 1.5rem; border-radius: var(--border-radius);
          box-shadow: var(--box-shadow); width: 100%;
        }
        .view-header {
          text-align: center; margin-bottom: 1.5rem; width: 100%;
          background-color: var(--card-bg); padding: 1rem 1.25rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow);
        }
        .view-header h2 { margin: 0; font-size: 1.4rem; color: var(--primary-color); font-weight: 600; }

        /* --- LANDING VIEW STYLES --- */
        #landingView .landing-actions { display: flex; flex-direction: column; gap: 1rem; align-items: center; }
        #landingView .landing-actions button { width: 100%; max-width: 300px; padding: 0.8rem 1.5rem; font-size: 1rem;}
        #landingView p { text-align: center; margin-bottom: 1.5rem; color: var(--text-color); font-size: 1.05rem;}

        /* --- MAIN APP VIEW (Original index.html) STYLES --- */
        #mainAppView .page-container { width: 100%; display: flex; flex-direction: column; gap: 1.5rem; }
        img#previewImg { max-width: 100%; height: auto; border-radius: var(--border-radius); box-shadow: 0 2px 6px rgba(0,0,0,.1); margin-top: 1rem; margin-bottom: 1.5rem; display: block; }
        .spinner { width: 40px; height: 40px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 1.5rem auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #responseBox { width: 100%; min-height: 180px; max-height: 450px; overflow-y: auto; padding: 1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.95rem; background-color: #fdfdfd; line-height: 1.6; white-space: pre-wrap; }
        #responseBox h3 { font-size: 1.15em; margin-top: 1em; margin-bottom: 0.5em; color: var(--primary-color); display: flex; align-items: center; justify-content: space-between; }
        #responseBox h3 .section-title-text { flex-grow: 1; }
        .copy-section-btn { background: none; border: 1px solid var(--border-color); color: var(--secondary-color); padding: 0.2em 0.4em; font-size: 0.75em; border-radius: 0.25rem; cursor: pointer; margin-left: 0.5em; opacity: 0.7; transition: opacity 0.2s, background-color 0.2s; flex-shrink: 0; }
        .copy-section-btn:hover { opacity: 1; background-color: var(--light-bg); color: var(--primary-color); }
        #responseBox ul { list-style-type: disc; margin-left: 1.5em; margin-bottom: 1em; padding-left: 0;}
        #responseBox li { margin-bottom: 0.3em; } #responseBox strong { font-weight: 600; } #responseBox p { margin-bottom: 0.8em; }
        .highlight-drug { background-color:var(--highlight-drug-bg); color:var(--highlight-drug-text); padding:0.1em 0.3em; border-radius:0.2em; font-weight:500; }
        .highlight-importance-high { background-color:var(--highlight-importance-high-bg); color:var(--highlight-importance-high-text); padding:0.1em 0.3em; border-radius:0.2em; font-weight:bold; }
        .highlight-importance-medium { background-color:var(--highlight-importance-medium-bg); color:var(--highlight-importance-medium-text); padding:0.1em 0.3em; border-radius:0.2em; font-weight:500; }
        .highlight-importance-low { background-color:var(--highlight-importance-low-bg); color:var(--highlight-importance-low-text); padding:0.1em 0.3em; border-radius:0.2em; font-weight:500; }
        select, textarea#promptEditor { width: 100%; padding: 0.6rem 0.9rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.95rem; background-color: #fff; color: var(--text-color); font-family: var(--font-family); }
        textarea#promptEditor { min-height: 250px; resize: vertical; margin-bottom: 1rem; }
        textarea#promptEditor:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
        #mainAppView h2 { font-weight: 600; color: var(--text-color); margin-bottom: 0.75rem; font-size: 1.3rem; }
        #captureSection > h2, #historySection > .history-header > h2, #promptSection > h2 { text-align: center; }
        #loadingSection { text-align: center; } #loadingSection p { margin-top: 0.5rem; font-size: 1rem; color: var(--secondary-color); }
        #previewSection .button-group { display: flex; flex-direction: column; gap: 0.6rem; margin-top: 1.2rem; }
        #previewSection select { margin-bottom: 0.6rem; }
        #resultSection { display: flex; flex-direction: column; }
        .result-actions { display: flex; justify-content: center; align-items: center; margin-top: 1.5rem; gap: 1rem; width: 100%; }
        .result-actions button { flex-grow: 0; min-width: 120px; }
        @media (max-width: 480px) { .result-actions { flex-direction: column; align-items: stretch; } .result-actions button { width: 100%; } }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .history-header h2 { margin-bottom: 0; flex-grow: 1; text-align: center;}
        #clearAllHistoryBtn { font-size: 0.8rem; padding: 0.4rem 0.8rem; flex-shrink: 0; }
        #historyCarouselContainer { overflow-x: auto; white-space: nowrap; padding-bottom: 1rem; margin-bottom: -1rem; }
        #historyCarousel { display: flex; gap: 0.75rem; }
        .history-item-wrapper { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: var(--text-color); width: 110px; position: relative; }
        .history-item { width: 100px; height: 100px; border: 2px solid var(--border-color); border-radius: var(--border-radius); overflow: hidden; cursor: pointer; transition: border-color 0.2s ease, transform 0.2s ease; margin-bottom: 0.25rem; position: relative; }
        .history-item:hover { border-color: var(--primary-color); transform: translateY(-2px); }
        .history-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .history-item-date { font-size: 0.75rem; color: var(--secondary-color); text-align: center; display: block; white-space: normal; line-height: 1.2; width: 100%; }
        .delete-history-item-btn { position: absolute; top: 3px; right: 3px; background-color: rgba(0,0,0,0.4); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; text-align: center; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.2s ease, background-color 0.2s ease; z-index: 10; }
        .history-item-wrapper:hover .delete-history-item-btn { opacity: 1; }
        .delete-history-item-btn:hover { background-color: var(--danger-color); }
        #noHistoryMessage { color: var(--secondary-color); font-style: italic; text-align: center; padding: 1rem 0;}
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s linear; }
        .modal-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0s 0s linear; }
        .modal-content { background-color: var(--card-bg); padding: 1.5rem 2rem; border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 450px; text-align: center; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-content p { margin-bottom: 1.5rem; font-size: 1.05rem; line-height: 1.5; }
        .modal-buttons { display: flex; justify-content: center; gap: 1rem; }
        .modal-buttons button { padding: 0.6rem 1.2rem; font-size: 0.9rem; }
        #promptCustomizationBtnContainer { text-align: center; margin-top: 0; }
        #promptSection .prompt-actions { display: flex; justify-content: space-around; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; }
        #promptSection .prompt-actions button { flex-grow: 1; min-width: 150px; }
        #promptStatus { font-size: 0.9rem; min-height: 1.3em; margin-top: 1rem; font-weight: 500; text-align: center; }
        #promptStatus.success { color: var(--success-color); } #promptStatus.info { color: var(--secondary-color); }
        .main-app-external-buttons-container { /* Container for buttons like Patient Info Generator at bottom of Main App view */
          width: 100%; max-width: 700px; display: flex; justify-content: center; padding: 1.5rem 0; gap: 1rem;
        }

        /* --- ADVICE GENERATOR VIEW STYLES --- */
        #adviceGeneratorView .form-group { margin-bottom: 1rem; }
        #adviceGeneratorView .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.95rem; color: var(--text-color); }
        #adviceGeneratorView .form-group input[type="text"], #adviceGeneratorView .form-group select {
          width: 100%; padding: 0.6rem 0.9rem; border: 1px solid var(--border-color);
          border-radius: var(--border-radius); font-size: 0.95rem; background-color: #fff; color: var(--text-color);
          font-family: var(--font-family);
        }
        #adviceGeneratorView .form-group input[type="text"]:focus, #adviceGeneratorView .form-group select:focus {
          outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        #adviceGeneratorStatusMessage { text-align:center; min-height:1.2em; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem;}
        #adviceGeneratorView .action-buttons { display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: center; flex-wrap: wrap;}
        #adviceGeneratorView .action-buttons button { min-width: 150px; }
        #adviceGeneratorLoadingIndicator { text-align: center; }
        #adviceGeneratorLoadingIndicator p { margin-top: 0.5rem; color: var(--secondary-color); font-size: 0.9rem;}
        
        /* --- ADVICE RESULT VIEW STYLES --- */
        #adviceResultView #adviceDisplayArea { padding: 1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: #fdfdfd; line-height: 1.7; min-height: 100px; font-size: 0.95rem; }
        #adviceResultView #adviceDisplayArea p { margin-bottom: 0.8em; } #adviceResultView #adviceDisplayArea p:last-child { margin-bottom: 0; }
        #adviceResultView .highlight-drugname { background-color: #e6f7ff; color: #005f8d; padding: 0.1em 0.3em; border-radius: 0.25rem; font-weight: 600;}
        #adviceResultView .highlight-term { background-color: #fffbe6; color: #856404; padding: 0.1em 0.3em; border-radius: 0.25rem; font-style: italic;}
        #adviceResultView .highlight-benefit { background-color: #e6ffe6; color: #155724; padding: 0.1em 0.3em; border-radius: 0.25rem; font-weight: 500;}
        #adviceResultView .highlight-caution { background-color: #ffe6e6; color: #721c24; padding: 0.1em 0.3em; border-radius: 0.25rem; font-weight: bold;}
        #adviceResultView .info-bar { margin-bottom: 1rem; font-size: 0.9rem; color: var(--secondary-color); line-height: 1.5; }
        #adviceResultView .info-bar strong { color: var(--text-color); font-weight: 600; }
        #adviceResultView .action-buttons { display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: center; flex-wrap: wrap;}
        #adviceResultView .action-buttons button { min-width: 150px; }

        [hidden] { display: none !important; }
    </style>
</head>
<body>

    <header id="appHeader">
      <img src="https://www.citypng.com/public/uploads/preview/black-circle-round-question-mark-icon-png-70175169496360405wfyhabkn.png" alt="Logo">
      <h1>Pharmacy Assistant Suite</h1>
    </header>

    <div id="apiKeyConfigArea">
      <h3>API Key Configuration</h3>
      <div class="api-key-form-group">
        <label for="apiKeyInput">OpenAI API Key:</label>
        <input type="password" id="apiKeyInput" placeholder="Enter your OpenAI API Key">
      </div>
      <div class="api-key-buttons">
        <button id="saveApiKeyBtn">Save</button>
        <button id="testApiKeyBtn" class="test-key">Test</button>
        <button id="clearApiKeyBtn" class="secondary">Clear</button>
      </div>
      <p id="apiKeyStatus" class="info"></p>
    </div>

    <div class="app-container">
        <!-- VIEW 0: Landing Page -->
        <div id="landingView">
            <header class="view-header">
                <h2>Welcome! Select a Tool:</h2>
            </header>
            <section class="view-section">
                <p>Choose an option below to get started.</p>
                <div class="landing-actions">
                    <button id="goToMainAppViewBtn">Interaction Finder</button>
                    <button id="goToAdviceGeneratorFromLandingBtn" class="green">Medication Advice Generator</button>
                </div>
            </section>
        </div>

        <!-- VIEW 1: Main Interaction Finder App -->
        <div id="mainAppView" hidden>
            <!-- Header for this specific view section -->
            <header class="view-header" style="margin-bottom: 0;"> <!-- No extra bottom margin if page-container handles it -->
                <h2>Prescription Interaction Finder</h2>
            </header>
            <div class="page-container"> 
                <section id="captureSection" class="view-section">
                  <h2>Take a Photo</h2>
                  <p style="margin-bottom: 1.2rem; color: #555; font-size: 0.9rem; text-align: center;">Upload an image of the prescription to analyze.</p>
                  <div style="text-align:center;"> <button id="takePhotoBtn">Take Photo or Upload</button> </div>
                  <input id="fileInput" type="file" accept="image/*" capture="environment" hidden>
                </section>
                <section id="historySection" class="view-section" hidden>
                    <div class="history-header"><h2>Recent Analyses</h2><button id="clearAllHistoryBtn" class="danger">Clear All</button></div>
                    <div id="historyCarouselContainer"> <div id="historyCarousel"></div> </div>
                    <p id="noHistoryMessage" hidden>No recent analyses found.</p>
                </section>
                <div id="promptCustomizationBtnContainer" hidden> <button id="goToPromptCustomizationBtn" class="secondary">Prompt Customization</button> </div>
                <section id="previewSection" class="view-section" hidden>
                  <h2>Confirm Prescription Image</h2> <img id="previewImg" alt="preview">
                  <div class="button-group">
                    <p style="margin-bottom: 0.5rem; text-align: center; font-size:0.9rem;">Select AI Model:</p>
                    <select id="modelSelect"><option value="gpt-4o-mini">GPT-4o-mini (Faster, Good)</option><option value="gpt-4o">GPT-4o (Slower, Best)</option></select>
                    <button id="usePhotoBtn">Use This Photo & Analyze</button> <button id="retakeBtn" class="secondary">Retake or Choose Different</button>
                  </div>
                </section>
                <section id="loadingSection" class="view-section" hidden> <div class="spinner"></div> <p>Analyzing image, please wait…</p> </section>
                <section id="resultSection" class="view-section" hidden>
                  <h2>Analysis Results</h2> <div id="responseBox" role="document" aria-live="polite"></div>
                  <div class="result-actions"><button id="copyResultsBtn">Copy Results</button><button id="restartBtn" class="secondary">Back to Start</button></div>
                </section>
                <section id="promptSection" class="view-section" hidden>
                    <h2>Customize System Prompt</h2>
                    <p style="font-size:0.85rem; color: var(--secondary-color); margin-bottom:1rem;">Modify the instructions given to the AI. Be careful, as significant changes can affect results.</p>
                    <textarea id="promptEditor" rows="10"></textarea>
                    <div class="prompt-actions"><button id="savePromptBtn">Save Prompt</button><button id="resetPromptBtn" class="secondary">Reset to Default</button><button id="returnToMainFromPromptBtn" class="secondary">Return to Main</button></div>
                    <p id="promptStatus"></p>
                </section>
            </div>
            <div class="main-app-external-buttons-container"> <!-- Renamed for clarity -->
                 <button id="backToLandingViewFromMainBtn" class="secondary">Back to Main Menu</button>
            </div>
        </div>

        <!-- VIEW 2: Advice Generator -->
        <div id="adviceGeneratorView" hidden>
            <header class="view-header"><h2>Generate Medication Advice</h2></header>
            <section class="view-section">
                <div class="form-group">
                    <label for="adviceDrugNameInput">Drug Name:</label>
                    <input type="text" id="adviceDrugNameInput" placeholder="e.g., Amoxicillin">
                </div>
                <div class="form-group">
                    <label for="adviceModelSelect">Select AI Model:</label>
                    <select id="adviceModelSelect">
                        <option value="gpt-4o-mini">GPT-4o-mini</option>
                        <option value="gpt-3.5-turbo">GPT-3.5-Turbo</option>
                        <option value="gpt-4o">GPT-4o</option>
                        <!-- Removed o3-mini as it's mapped in JS and might confuse user if listed explicitly -->
                    </select>
                </div>
                <p id="adviceGeneratorStatusMessage"></p>
                <div id="adviceGeneratorLoadingIndicator" hidden>
                    <div class="spinner" style="width:30px; height:30px; border-width:4px;"></div>
                    <p>Generating advice, please wait...</p>
                </div>
                <div class="action-buttons">
                    <button id="generateAdviceActualBtn">Generate Advice</button>
                    <button id="returnToLandingViewBtn1" class="secondary">Back to Main Menu</button>
                </div>
            </section>
        </div>

        <!-- VIEW 3: Advice Result -->
        <div id="adviceResultView" hidden>
            <header class="view-header"><h2>Medication Advice Result</h2></header>
            <section class="view-section">
                <div class="info-bar">
                    <p><strong>Drug:</strong> <span id="resultDrugName">N/A</span></p>
                    <p><strong>Model Used:</strong> <span id="resultModelUsed">N/A</span></p>
                </div>
                <div id="adviceDisplayArea"><p style="color: var(--secondary-color);">Loading advice...</p></div>
                <div class="action-buttons">
                    <button id="generateNewAdviceBtn">Generate New Advice</button>
                    <button id="returnToLandingViewBtn2" class="secondary">Back to Main Menu</button>
                </div>
            </section>
        </div>
    </div> <!-- End of .app-container -->

    <div id="customModalOverlay" class="modal-overlay">
      <div class="modal-content"> <p id="modalMessage">Are you sure?</p> <div class="modal-buttons"> <button id="modalConfirmBtn" class="danger">Confirm</button> <button id="modalCancelBtn" class="secondary">Cancel</button> </div> </div>
    </div>

<script>
    // --- Global Constants and Variables ---
    const MAX_HISTORY_ITEMS = 7;
    const HISTORY_STORAGE_KEY = 'interactionFinderHistory';
    const CUSTOM_PROMPT_STORAGE_KEY = 'interactionFinderCustomPrompt';
    const API_KEY_STORAGE_ITEM = 'interactionFinderApiKey';
    const DEFAULT_SYSTEM_PROMPT = `You are a hospital pharmacist analyzing a prescription image. Format your response strictly using Markdown: 1. Start with a heading: '### Detected Medications'. * Under this, use a bulleted list (*). For each drug, use the format: * DRUG{Drug Name} Dosage (e.g., * DRUG{Amoxicillin} 250mg three times daily). 2. Next heading: '### Interactions Found'. * Bulleted list of any drug-drug interactions identified. If none, state "No significant interactions found." For each interaction pair, use DRUG{} for each drug. e.g. * DRUG{Warfarin} and DRUG{Aspirin}. 3. Next heading: '### Consequences & Importance'. * For each interaction, explain its consequences and rate its importance/danger using IMPORTANCE{Severity} (e.g., IMPORTANCE{High}, IMPORTANCE{Medium}, IMPORTANCE{Low}). 4. Final heading: '### Recommendations'. * Provide clear, actionable recommendations. Your primary task is to clearly state the drugs and dosages, then identify and report interactions, their consequences, importance, and your recommendations. Keep it concise. If your view of the prescription is obstructed or unreadable, state this first under a heading '### Readability Issues'. Do not include disclaimers, refuse to answer, or suggest consulting external resources unless absolutely critical for immediate patient safety.`;

    let appApiKey = '';
    let currentActiveView = 'landingView'; // Start with the landing view

    // --- Utility Functions ---
    function sel(id){ return document.getElementById(id); }
    const showEl = el => { if(el) el.hidden = false; };
    const hideEl = el => { if(el) el.hidden = true; };

    // --- View Switching Logic ---
    const allViews = [sel('landingView'), sel('mainAppView'), sel('adviceGeneratorView'), sel('adviceResultView')];
    function switchToView(viewId) {
        allViews.forEach(view => { if(view) hideEl(view); });
        const viewToShow = sel(viewId);
        if (viewToShow) {
            showEl(viewToShow);
            currentActiveView = viewId;
            window.scrollTo(0, 0);
             // If switching to mainAppView, ensure its internal state is reset or set appropriately
            if (viewId === 'mainAppView' && !sel('resultSection').hidden) {
                // If a result is showing, don't reset to capture, let user decide via restart button
            } else if (viewId === 'mainAppView') {
                 switchToMainAppSection('captureSection'); // Default to capture section
            }
        } else {
            console.error("Attempted to switch to non-existent view:", viewId);
            showEl(sel('landingView')); 
            currentActiveView = 'landingView';
        }
    }

    // --- API Key Management (SHARED) ---
    const apiKeyInput = sel('apiKeyInput'), saveApiKeyBtn = sel('saveApiKeyBtn'),
          testApiKeyBtn = sel('testApiKeyBtn'), clearApiKeyBtn = sel('clearApiKeyBtn'),
          apiKeyStatus = sel('apiKeyStatus');

    function updateStatusWithMessage(element, message, type = 'info', duration = 4000) { /* ... same as before ... */ if (!element) return; element.textContent = message; element.className = type; if (message && duration > 0) { setTimeout(() => { if (element.textContent === message) { element.textContent = ''; element.className = 'info';}}, duration); } }
    function updateApiKeyDisplayStatus(message, type = 'info') { updateStatusWithMessage(apiKeyStatus, message, type); }
    function loadApiKeyFromStorage() { /* ... same as before ... */ const k=localStorage.getItem(API_KEY_STORAGE_ITEM); if(k){apiKeyInput.value=k;appApiKey=k;updateApiKeyDisplayStatus('API Key loaded.','info');}else{updateApiKeyDisplayStatus('Please enter API Key.','info');} }
    if(saveApiKeyBtn) saveApiKeyBtn.onclick = () => { /* ... same as before ... */ const k=apiKeyInput.value.trim();if(k&&k.startsWith('sk-')){localStorage.setItem(API_KEY_STORAGE_ITEM,k);appApiKey=k;updateApiKeyDisplayStatus('API Key saved!','success');}else{updateApiKeyDisplayStatus(k?'Invalid Key format.':'Key cannot be empty.','error');} };
    if(testApiKeyBtn) testApiKeyBtn.onclick = async () => { /* ... same as before ... */ const k=apiKeyInput.value.trim();if(!k){updateApiKeyDisplayStatus('Enter key to test.','error');return;} updateApiKeyDisplayStatus('Testing...','info');try{const r=await fetch('https://api.openai.com/v1/models',{headers:{'Authorization':`Bearer ${k}`}});if(r.ok){updateApiKeyDisplayStatus('Key valid!','success');if(k!==appApiKey){localStorage.setItem(API_KEY_STORAGE_ITEM,k);appApiKey=k;}}else{const e=await r.json();updateApiKeyDisplayStatus(`Test failed: ${e.error?.message||r.statusText}`,'error');}}catch(e){console.error("API Key Test Error:", e); updateApiKeyDisplayStatus('Test failed: Network error.','error');} };
    if(clearApiKeyBtn) clearApiKeyBtn.onclick = () => { /* ... same as before ... */ localStorage.removeItem(API_KEY_STORAGE_ITEM);apiKeyInput.value='';appApiKey='';updateApiKeyDisplayStatus('API Key cleared.','info'); };

    // --- LANDING VIEW Logic ---
    const goToMainAppViewBtn = sel('goToMainAppViewBtn');
    const goToAdviceGeneratorFromLandingBtn = sel('goToAdviceGeneratorFromLandingBtn');

    if(goToMainAppViewBtn) goToMainAppViewBtn.onclick = () => {
        switchToView('mainAppView');
        // switchToMainAppSection('captureSection'); // This is now handled in switchToView
    };
    if(goToAdviceGeneratorFromLandingBtn) goToAdviceGeneratorFromLandingBtn.onclick = () => switchToView('adviceGeneratorView');


    // --- MAIN APP VIEW (Interaction Finder) Logic ---
    const takePhotoBtn=sel('takePhotoBtn'), fileInput=sel('fileInput'), /* ... all other main app selectors ... */
          previewImg =sel('previewImg'), usePhotoBtn=sel('usePhotoBtn'), retakeBtn=sel('retakeBtn'),
          modelSelectIF=sel('modelSelect'), // Renamed to avoid conflict if another modelSelect exists
          loadingSec = sel('loadingSection'), responseBox=sel('responseBox'), restartBtn=sel('restartBtn'),
          copyResultsBtn = sel('copyResultsBtn'), historyCarousel=sel('historyCarousel'),
          noHistoryMessage=sel('noHistoryMessage'), historySectionElement=sel('historySection'),
          historyCarouselContainer=sel('historyCarouselContainer'), clearAllHistoryBtn=sel('clearAllHistoryBtn'),
          customModalOverlay=sel('customModalOverlay'), modalMessage=sel('modalMessage'),
          modalConfirmBtn=sel('modalConfirmBtn'), modalCancelBtn=sel('modalCancelBtn'),
          goToPromptCustomizationBtn=sel('goToPromptCustomizationBtn'),
          promptCustomizationBtnContainer=sel('promptCustomizationBtnContainer'),
          promptSectionElement=sel('promptSection'), promptEditor=sel('promptEditor'),
          savePromptBtn=sel('savePromptBtn'), resetPromptBtn=sel('resetPromptBtn'),
          returnToMainFromPromptBtn=sel('returnToMainFromPromptBtn'), promptStatus=sel('promptStatus'),
          patientInfoGeneratorBtnExternal = sel('patientInfoGeneratorBtnExternal'),
          backToLandingViewFromMainBtn = sel('backToLandingViewFromMainBtn');
    
    let base64Image=''; let analysisHistory = []; let currentSystemPrompt = DEFAULT_SYSTEM_PROMPT; let currentConfirmCallback = null;
    const allMainAppPageElementsToToggle = sel('mainAppView') ? Array.from(sel('mainAppView').querySelector('.page-container').querySelectorAll('section, div#promptCustomizationBtnContainer')) : [];

    function switchToMainAppSection(targetSectionId){ /* ... same as before ... */ if(!sel('mainAppView')) return; allMainAppPageElementsToToggle.forEach(el => hideEl(el)); const sectionToShow = sel(targetSectionId); if (sectionToShow) showEl(sectionToShow); if (targetSectionId === 'captureSection') { showEl(historySectionElement); showEl(promptCustomizationBtnContainer); if (analysisHistory.length > 0) { hideEl(noHistoryMessage); showEl(historyCarouselContainer); showEl(clearAllHistoryBtn); } else { showEl(noHistoryMessage); hideEl(historyCarouselContainer); hideEl(clearAllHistoryBtn); } } }
    function updatePromptStatus(message, type = 'info') { updateStatusWithMessage(promptStatus, message, type); }
    function showCustomConfirm(message, onConfirm) { /* ... same as before ... */ if(!modalMessage || !customModalOverlay) return; modalMessage.textContent = message; currentConfirmCallback = onConfirm; customModalOverlay.classList.add('active'); }
    function hideCustomConfirm() { /* ... same as before ... */ if(!customModalOverlay) return; customModalOverlay.classList.remove('active'); currentConfirmCallback = null; }
    if(modalConfirmBtn) modalConfirmBtn.onclick = () => { if (currentConfirmCallback) currentConfirmCallback(); hideCustomConfirm(); };
    if(modalCancelBtn) modalCancelBtn.onclick = hideCustomConfirm;
    if(customModalOverlay) customModalOverlay.onclick = (e) => { if (e.target === customModalOverlay) hideCustomConfirm(); };
    function loadHistory() { /* ... same as before ... */ const storedHistory = localStorage.getItem(HISTORY_STORAGE_KEY); try { analysisHistory = storedHistory ? JSON.parse(storedHistory) : []; } catch (e) { analysisHistory = []; localStorage.removeItem(HISTORY_STORAGE_KEY); } renderHistoryCarousel(); }
    function saveAnalysisToHistory(imgBase64, respHtml, model) { /* ... same as before ... */ const newItem = { id: Date.now(), imageBase64: imgBase64, responseHtml: respHtml, modelUsed: model, timestamp: Date.now() }; analysisHistory.unshift(newItem); if (analysisHistory.length > MAX_HISTORY_ITEMS) analysisHistory.length = MAX_HISTORY_ITEMS; localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(analysisHistory)); renderHistoryCarousel(); }
    function deleteHistoryItem(itemId) { /* ... same as before ... */ showCustomConfirm('Delete this analysis from history?', () => { analysisHistory = analysisHistory.filter(item => item.id !== itemId); localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(analysisHistory)); renderHistoryCarousel(); }); }
    if(clearAllHistoryBtn) clearAllHistoryBtn.onclick = () => { /* ... same as before ... */ showCustomConfirm('Clear all recent analyses? This cannot be undone.', () => { analysisHistory = []; localStorage.removeItem(HISTORY_STORAGE_KEY); renderHistoryCarousel(); }); };
    function renderHistoryCarousel() { /* ... same as before, ensure all elements exist ... */ if(!historyCarousel || !noHistoryMessage || !historyCarouselContainer || !clearAllHistoryBtn) return; historyCarousel.innerHTML = ''; if (analysisHistory.length === 0) { showEl(noHistoryMessage); hideEl(historyCarouselContainer); hideEl(clearAllHistoryBtn); } else { hideEl(noHistoryMessage); showEl(historyCarouselContainer); showEl(clearAllHistoryBtn); analysisHistory.forEach(item => { const w = document.createElement('div'); w.className = 'history-item-wrapper'; const iDiv = document.createElement('div'); iDiv.className = 'history-item'; iDiv.onclick = () => loadAnalysisFromHistoryItem(item); const img = document.createElement('img'); img.src = `data:image/jpeg;base64,${item.imageBase64}`; img.alt = `Analyzed ${new Date(item.timestamp).toLocaleDateString()}`; iDiv.appendChild(img); const del = document.createElement('button'); del.className = 'delete-history-item-btn'; del.innerHTML = '×'; del.title = 'Delete'; del.onclick = (e) => { e.stopPropagation(); deleteHistoryItem(item.id); }; iDiv.appendChild(del); const date = document.createElement('span'); date.className = 'history-item-date'; const d=new Date(item.timestamp); date.textContent = `${d.getMonth()+1}/${d.getDate()}/${String(d.getFullYear()).slice(-2)} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; w.appendChild(iDiv); w.appendChild(date); historyCarousel.appendChild(w); });}}
    function loadAnalysisFromHistoryItem(item) { /* ... same as before ... */ if(item && responseBox){ responseBox.innerHTML=item.responseHtml; switchToMainAppSection('resultSection'); } }
    function loadCustomPrompt() { /* ... same as before ... */ const sp = localStorage.getItem(CUSTOM_PROMPT_STORAGE_KEY); currentSystemPrompt = sp ? sp : DEFAULT_SYSTEM_PROMPT; if(promptEditor) promptEditor.value = currentSystemPrompt; if(sp && promptStatus) updatePromptStatus('Custom prompt loaded.','info', 2000); }
    if(goToPromptCustomizationBtn) goToPromptCustomizationBtn.onclick = () => { if(promptEditor) promptEditor.value = currentSystemPrompt; switchToMainAppSection('promptSection'); };
    if(savePromptBtn) savePromptBtn.onclick = () => { /* ... same as before ... */ const np = promptEditor.value.trim(); if (np) { currentSystemPrompt = np; localStorage.setItem(CUSTOM_PROMPT_STORAGE_KEY, np); updatePromptStatus('Prompt saved successfully!', 'success'); } else { updatePromptStatus('Prompt cannot be empty. Reverted.', 'error'); promptEditor.value = currentSystemPrompt; }};
    if(resetPromptBtn) resetPromptBtn.onclick = () => { /* ... same as before ... */ showCustomConfirm("Reset prompt to default?", () => { currentSystemPrompt = DEFAULT_SYSTEM_PROMPT; promptEditor.value = DEFAULT_SYSTEM_PROMPT; localStorage.removeItem(CUSTOM_PROMPT_STORAGE_KEY); updatePromptStatus('Prompt reset to default.', 'info'); }); };
    if(returnToMainFromPromptBtn) returnToMainFromPromptBtn.onclick = () => switchToMainAppSection('captureSection');
    if(takePhotoBtn) takePhotoBtn.onclick =()=>fileInput.click();
    if(retakeBtn) retakeBtn.onclick    =()=>fileInput.click();
    if(fileInput) fileInput.onchange   = async () => { /* ... same as before ... */ const f=fileInput.files[0];if(!f)return;try{base64Image=await toBase64(f);previewImg.src='data:image/jpeg;base64,'+base64Image;switchToMainAppSection('previewSection');}catch(e){console.error("File error:",e);alert("Could not load image.");}};
    if(usePhotoBtn) usePhotoBtn.onclick=()=>analyzeImage();
    if(restartBtn) restartBtn.onclick=()=> { /* ... same as before ... */ if(responseBox) responseBox.innerHTML='';if(fileInput) fileInput.value='';base64Image='';if(previewImg) previewImg.src='';if(modelSelectIF) modelSelectIF.value='gpt-4o-mini';switchToMainAppSection('captureSection');}; // Use modelSelectIF
    if(copyResultsBtn) copyResultsBtn.onclick = () => { /* ... same as before ... */ const t=responseBox.textContent;if(navigator.clipboard&&t){navigator.clipboard.writeText(t).then(()=>updateApiKeyDisplayStatus('Results copied!','success', 2000)).catch(e=>updateApiKeyDisplayStatus('Failed to copy.','error', 2000));}};
    function markdownToHtml(mdText) { /* ... same as before ... */ let h = mdText.replace(/&/g, '&').replace(/</g, '<').replace(/>/g, '>'); h = h.replace(/DRUG\{(.*?)\}/gim, '<span class="highlight-drug">$1</span>'); h = h.replace(/IMPORTANCE\{(High|Medium|Low)\}/gim, (m,s)=>`<span class="highlight-importance-${s.toLowerCase()}">${s}</span>`); h = h.replace(/^### (.*$)/gim, '<h3><span class="section-title-text">$1</span></h3>'); h = h.replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>').replace(/__(.*?)__/gim, '<strong>$1</strong>'); h = h.replace(/\*(.*?)\*/gim, '<em>$1</em>').replace(/_(.*?)_/gim, '<em>$1</em>'); let iL=false; h=h.split('\n').map(l=>{const tL=l.trim();if(tL.match(/^[\*\-]\s+/)){let liC=tL.substring(tL.indexOf(' ')+1).trim();let li=`<li>${liC}</li>`;if(!iL){iL=true;return `<ul>${li}`;}return li;}else{let lR=l;if(iL){lR=`</ul>${lR}`;iL=false;}const tNL=lR.trim();if(tNL&&!tNL.startsWith('<h3')&&!tNL.startsWith('<ul>')&&!tNL.endsWith('</ul>')&&!tNL.startsWith('<p>')&&!tNL.endsWith('</p>')){return `<p>${tNL}</p>`;}return lR;}}).join('\n');if(iL)h+='</ul>';h=h.replace(/<\/ul>\s*<p>/gim,'</ul><p>').replace(/<p>\s*<\/p>/gim,'').replace(/\n\s*\n/g,'\n');return h.trim();}
    function addCopySectionButtonsToResponseBox() { /* ... same as before ... */ if(!responseBox) return; const hs=responseBox.querySelectorAll('h3');hs.forEach(hE=>{let tS=hE.querySelector('.section-title-text');if(!tS){const tT=hE.textContent;hE.innerHTML='';tS=document.createElement('span');tS.className='section-title-text';tS.textContent=tT;hE.appendChild(tS);}if(hE.querySelector('.copy-section-btn'))return; const cB=document.createElement('button');cB.className='copy-section-btn';cB.textContent='Copy';cB.title=`Copy "${tS.textContent}" section`;hE.appendChild(cB);});}
    if(responseBox) responseBox.addEventListener('click', function(event) { /* ... same as before ... */ if(event.target.classList.contains('copy-section-btn')){const hE=event.target.closest('h3');if(!hE)return;let cTC=hE.querySelector('.section-title-text').textContent+'\n';let nE=hE.nextElementSibling;while(nE&&nE.tagName!=='H3'){if(nE.tagName==='UL'){Array.from(nE.querySelectorAll('li')).forEach(li=>{cTC+=`• ${li.textContent.trim()}\n`;});}else{cTC+=nE.textContent.trim()+'\n';}nE=nE.nextElementSibling;}if(navigator.clipboard){navigator.clipboard.writeText(cTC.trim()).then(()=>updateApiKeyDisplayStatus('Section copied!','success',2000)).catch(err=>updateApiKeyDisplayStatus('Failed to copy.','error',2000));}}});
    async function analyzeImage(){ /* ... same as before, ensure modelSelectIF is used ... */ if(!appApiKey){updateApiKeyDisplayStatus('API Key required.','error');apiKeyInput.focus();if(loadingSec && !loadingSec.hidden)switchToMainAppSection('previewSection');if(responseBox) responseBox.innerHTML='<p style="color:var(--danger-color);">API Key missing.</p>';return;} if(responseBox) responseBox.innerHTML='';switchToMainAppSection('loadingSection'); const sM=modelSelectIF.value; const body={model:sM,messages:[{role:'user',content:[{type:'text',text:currentSystemPrompt},{type:'image_url',image_url:{url:'data:image/jpeg;base64,'+base64Image}}]}],max_tokens:2000}; try{ const rs=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+appApiKey},body:JSON.stringify(body)}); const d=await rs.json(); if(rs.ok&&d.choices?.[0]?.message?.content){ const rm=d.choices[0].message.content.trim(); const hr=markdownToHtml(rm); responseBox.innerHTML=hr; addCopySectionButtonsToResponseBox(); saveAnalysisToHistory(base64Image, responseBox.innerHTML, sM); }else{ const em=d.error?`${d.error.message} (Code: ${d.error.code})`:'Unknown API error.'; responseBox.innerHTML=`<p style="color:var(--danger-color);">Error: ${em}</p>`; if(d.error?.code==='invalid_api_key'||d.error?.type==='auth_error'){updateApiKeyDisplayStatus('Invalid API Key.','error');appApiKey='';localStorage.removeItem(API_KEY_STORAGE_ITEM);apiKeyInput.value='';}}}catch(e){if(responseBox) responseBox.innerHTML='<p style="color:var(--danger-color);">Request failed. Check network.</p>';} finally{switchToMainAppSection('resultSection');}}
    function toBase64(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result.split(',')[1]);r.onerror=rej;r.readAsDataURL(file);});}
    if(patientInfoGeneratorBtnExternal) patientInfoGeneratorBtnExternal.onclick = () => { window.open('info.html', '_blank'); };
    if(backToLandingViewFromMainBtn) backToLandingViewFromMainBtn.onclick = () => switchToView('landingView');

    // --- ADVICE GENERATOR VIEW Logic ---
    const adviceDrugNameInput = sel('adviceDrugNameInput');
    const adviceModelSelect = sel('adviceModelSelect'); // This ID is unique to this view now
    const generateAdviceActualBtn = sel('generateAdviceActualBtn');
    const returnToLandingViewBtn1 = sel('returnToLandingViewBtn1');
    const adviceGeneratorStatusMessage = sel('adviceGeneratorStatusMessage');
    const adviceGeneratorLoadingIndicator = sel('adviceGeneratorLoadingIndicator');

    if(adviceModelSelect) adviceModelSelect.value = 'gpt-4o-mini';

    function updateAdviceGeneratorStatus(message, isError = false, duration = 5000) { /* ... same as before ... */ if (!adviceGeneratorStatusMessage) return; adviceGeneratorStatusMessage.textContent = message; adviceGeneratorStatusMessage.style.color = isError ? 'var(--danger-color)' : 'var(--success-color)'; if (!isError && message && !message.toLowerCase().includes('error') && !message.toLowerCase().includes('valid')) { adviceGeneratorStatusMessage.style.color = 'var(--secondary-color)'; } if (message && duration > 0) { setTimeout(() => { if (adviceGeneratorStatusMessage.textContent === message) adviceGeneratorStatusMessage.textContent = ''; }, duration); } }
    if(generateAdviceActualBtn) generateAdviceActualBtn.onclick = async () => { /* ... same as before, but use adviceModelSelect ... */ const drugName = adviceDrugNameInput.value.trim(); const selectedModelDisplay = adviceModelSelect.value; if (!appApiKey) { updateAdviceGeneratorStatus('API Key is missing. Configure it at the top.', true); apiKeyInput.focus(); return; } if (!drugName) { updateAdviceGeneratorStatus('Please enter a drug name.', true); adviceDrugNameInput.focus(); return; } updateAdviceGeneratorStatus(''); hideEl(adviceGeneratorStatusMessage); showEl(adviceGeneratorLoadingIndicator); generateAdviceActualBtn.disabled = true; if(returnToLandingViewBtn1) returnToLandingViewBtn1.disabled = true; let modelForAPI; switch (selectedModelDisplay) { case 'gpt-3.5-turbo': modelForAPI = 'gpt-3.5-turbo'; break; case 'gpt-4o-mini': modelForAPI = 'gpt-4o-mini'; break; case 'gpt-4o': modelForAPI = 'gpt-4o'; break; default: modelForAPI = 'gpt-4o-mini'; } const userPrompt = `Generate a patient-friendly explanation about <span class="highlight-drugname">${drugName}</span>. Your task is to clearly inform someone who has never taken this medication about: - What <span class="highlight-drugname">${drugName}</span> is and why it is prescribed. - How to correctly take it (including dosage, timing, or any instructions). - Important <span class="highlight-term">medical terms</span> and the mechanism of action, if relevant. - Expected <span class="highlight-benefit">benefits</span> and outcomes. - Potential <span class="highlight-caution">side effects</span>, warnings, and any necessary precautions. Use simple, non-technical language that any patient can understand. Format the output using the following HTML <span> tags: - \`<span class="highlight-drugname">${drugName}</span>\` for every mention of the drug. - \`<span class="highlight-term">{medical_term}</span>\` for key medical concepts or mechanisms. - \`<span class="highlight-benefit">{positive_effect_or_benefit}</span>\` for benefits and improvements. - \`<span class="highlight-caution">{caution_side_effect_or_warning}</span>\` for any risks or side effects. Structure the response into 1–3 concise paragraphs without introductory or concluding fluff. If "${drugName}" is not a recognized drug, respond with a short notice asking for a valid name and suggest similar known drugs. If ${drugName} is not quite correct, change it yourself to the correct name.`; try { const response = await fetch('https://api.openai.com/v1/chat/completions', { method: 'POST', headers: {'Content-Type':'application/json','Authorization':`Bearer ${appApiKey}`}, body: JSON.stringify({model: modelForAPI, messages: [{ role: 'user', content: userPrompt }], max_tokens: 350 }) }); const data = await response.json(); if (response.ok && data.choices?.[0]?.message?.content) { const adviceText = data.choices[0].message.content.trim(); displayAdviceResult(drugName, `${selectedModelDisplay} (API: ${modelForAPI})`, adviceText); } else { const errorMsg = data.error ? `${data.error.message} (Code: ${data.error.code})` : 'Unknown API error.'; updateAdviceGeneratorStatus(`Error generating advice: ${errorMsg}`, true, 7000); showEl(adviceGeneratorStatusMessage); if(data.error?.code==='invalid_api_key'||data.error?.type==='auth_error'){ updateApiKeyDisplayStatus('Invalid API Key.','error');appApiKey='';localStorage.removeItem(API_KEY_STORAGE_ITEM);apiKeyInput.value='';} } } catch (error) { console.error("Advice Generation Request failed:", error); updateAdviceGeneratorStatus('Request failed. Check network or console for details.', true, 7000); showEl(adviceGeneratorStatusMessage); } finally { hideEl(adviceGeneratorLoadingIndicator); generateAdviceActualBtn.disabled = false; if(returnToLandingViewBtn1) returnToLandingViewBtn1.disabled = false; } };
    if(returnToLandingViewBtn1) returnToLandingViewBtn1.onclick = () => switchToView('landingView');

    // --- ADVICE RESULT VIEW Logic ---
    const resultDrugName = sel('resultDrugName');
    const resultModelUsed = sel('resultModelUsed');
    const adviceDisplayArea = sel('adviceDisplayArea');
    const generateNewAdviceBtn = sel('generateNewAdviceBtn');
    const returnToLandingViewBtn2 = sel('returnToLandingViewBtn2');

    function displayAdviceResult(drug, model, adviceHTML) { /* ... same as before ... */ if(resultDrugName) resultDrugName.textContent = drug; if(resultModelUsed) resultModelUsed.textContent = model; if(adviceDisplayArea) adviceDisplayArea.innerHTML = adviceHTML; switchToView('adviceResultView'); }
    if(generateNewAdviceBtn) generateNewAdviceBtn.onclick = () => switchToView('adviceGeneratorView');
    if(returnToLandingViewBtn2) returnToLandingViewBtn2.onclick = () => switchToView('landingView');

    // --- Initial Application Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        loadApiKeyFromStorage();
        loadHistory(); // For Interaction Finder
        loadCustomPrompt(); // For Interaction Finder
        // switchToMainAppSection('captureSection'); // Not needed here, handled by switchToView if mainAppView is targeted
        switchToView('landingView'); // Start with the new landing page
    });
</script>
</body>
</html>