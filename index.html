<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pharmacy Assistant Suite</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
          --primary-color: #007bff; --primary-hover-color: #0056b3; --secondary-color: #6c757d;
          --secondary-hover-color: #545b62; --success-color: #28a745; --danger-color: #dc3545;
          --warning-color: #ffc107; --warning-text-color: #856404; --warning-bg-color: #fff3cd;
          --purple-color: #6f42c1; --purple-hover-color: #5a32a3; --info-color: #17a2b8; 
          --highlight-drug-bg: #e6f7ff; --highlight-drug-text: #005f8d;
          --highlight-importance-high-bg: #ffe6e6; --highlight-importance-high-text: #c00;
          --highlight-importance-medium-bg: #fff0e6; --highlight-importance-medium-text: #c50;
          --highlight-importance-low-bg: #e6ffe6; --highlight-importance-low-text: #070;
          --light-bg: #f8f9fa; --card-bg: #ffffff; --text-color: #333; --border-color: #dee2e6;
          --border-radius: 0.5rem; --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
          --font-family: 'Poppins', system-ui, sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
          font-family: var(--font-family); background-color: var(--light-bg); color: var(--text-color);
          display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 1.5rem 1rem;
        }
        
        .app-container { width: 100%; max-width: 700px; display: flex; flex-direction: column; gap: 1.5rem; margin-top: 1.5rem; }
        #appHeader { display: flex; align-items: center; gap: 0.8rem; margin-bottom: 1rem; width: 100%; max-width: 700px; }
        #appHeader img { width: 40px; height: 40px; border-radius: 50%; }
        #appHeader h1 { margin: 0; font-size: 1.6rem; color: var(--text-color); font-weight: 600;}

        #apiKeyConfigArea { background-color: var(--card-bg); padding: 1rem 1.25rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow); width: 100%; max-width: 700px; }
        #apiKeyConfigArea h3 { margin-top: 0; margin-bottom: 0.75rem; font-size: 1.15rem; color: var(--text-color);}
        .api-key-form-group { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        #apiKeyConfigArea label { font-weight: 500; flex-shrink: 0; font-size: 0.9rem; color: var(--text-color);}
        #apiKeyConfigArea input[type="password"] { flex-grow: 1; padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.9rem; min-width: 180px; font-family: var(--font-family); color: var(--text-color); }
        #apiKeyConfigArea input[type="password"]:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
        #apiKeyConfigArea .api-key-buttons button { padding: 0.5rem 0.9rem; font-size: 0.85rem; margin-right: 0.4rem; }
        #apiKeyConfigArea .api-key-buttons button:last-child { margin-right: 0; }
        #apiKeyConfigArea .api-key-buttons button.test-key { background-color: var(--success-color); }
        #apiKeyConfigArea .api-key-buttons button.test-key:hover { background-color: #1e7e34; }
        #apiKeyStatus { font-size: 0.85rem; min-height: 1.2em; margin-top: 0.4rem; font-weight: 500; }
        #apiKeyStatus.success { color: var(--success-color); } #apiKeyStatus.error { color: var(--danger-color); } #apiKeyStatus.info { color: var(--secondary-color); }

        button { padding: 0.7rem 1.4rem; font-size: 0.95rem; font-weight: 500; border: none; border-radius: var(--border-radius); cursor: pointer; background: var(--primary-color); color: #fff; transition: background-color 0.2s ease-in-out, transform 0.1s ease; font-family: var(--font-family); }
        button:hover { background: var(--primary-hover-color); transform: translateY(-1px); }
        button.secondary { background-color: var(--secondary-color); } button.secondary:hover { background-color: var(--secondary-hover-color); }
        button.danger { background-color: var(--danger-color); } button.danger:hover { background-color: #c82333; }
        button.purple { background-color: var(--purple-color); } button.purple:hover { background-color: var(--purple-hover-color); }
        button.green { background-color: var(--success-color); } button.green:hover { background-color: #1e7e34; }
        button.warning { background-color: var(--warning-color); color: #333; } button.warning:hover { background-color: #e0a800; }
        button.info { background-color: var(--info-color); color: #fff;} button.info:hover { background-color: #138496; }
        button:disabled { background-color: var(--secondary-color); opacity: 0.7; cursor: not-allowed; transform: translateY(0); }

        .view-section { background-color: var(--card-bg); padding: 1.25rem 1.5rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow); width: 100%; }
        .view-header { text-align: center; margin-bottom: 1.5rem; width: 100%; background-color: var(--card-bg); padding: 1rem 1.25rem; border-radius: var(--border-radius); box-shadow: var(--box-shadow); }
        .view-header h2 { margin: 0; font-size: 1.4rem; color: var(--primary-color); font-weight: 600; }

        /* Landing View */
        #landingView .landing-actions { display: flex; flex-direction: column; gap: 1rem; align-items: center; }
        #landingView .landing-actions button { width: 100%; max-width: 350px; padding: 0.8rem 1.5rem; font-size: 1rem;}
        #landingView p { text-align: center; margin-bottom: 1.5rem; color: var(--text-color); font-size: 1.05rem;}

        /* Main App View (Interaction Finder) - Copied styles from original more completely */
        #mainAppView .page-container { width: 100%; display: flex; flex-direction: column; gap: 1.5rem; }
        #mainAppView h2 { font-weight: 600; color: var(--text-color); margin-bottom: 0.75rem; font-size: 1.3rem; }
        #captureSection > h2, #historySection > .history-header > h2, #promptSection > h2 { text-align: center; }
        img#previewImg { max-width: 100%; height: auto; border-radius: var(--border-radius); box-shadow: 0 2px 6px rgba(0,0,0,.1); margin-top: 1rem; margin-bottom: 1.5rem; display: block; }
        .spinner { width: 40px; height: 40px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 1.5rem auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #responseBox { width: 100%; min-height: 180px; max-height: 450px; overflow-y: auto; padding: 1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.95rem; background-color: #fdfdfd; line-height: 1.6; white-space: pre-wrap; }
        #responseBox h3 { font-size: 1.15em; margin-top: 1em; margin-bottom: 0.5em; color: var(--primary-color); display: flex; align-items: center; justify-content: space-between; }
        #responseBox h3 .section-title-text { flex-grow: 1; }
        .copy-section-btn { background: none; border: 1px solid var(--border-color); color: var(--secondary-color); padding: 0.2em 0.4em; font-size: 0.75em; border-radius: 0.25rem; cursor: pointer; margin-left: 0.5em; opacity: 0.7; transition: opacity 0.2s, background-color 0.2s; flex-shrink: 0; }
        .copy-section-btn:hover { opacity: 1; background-color: var(--light-bg); color: var(--primary-color); }
        #responseBox ul { list-style-type: disc; margin-left: 1.5em; margin-bottom: 1em; padding-left: 0;}
        #responseBox li { margin-bottom: 0.3em; } #responseBox strong { font-weight: 600; } #responseBox p { margin-bottom: 0.8em; }
        .highlight-drug { background-color:var(--highlight-drug-bg); color:var(--highlight-drug-text); padding:0.1em 0.3em; border-radius:0.2em; font-weight:500; }
        .highlight-importance-high { background-color:var(--highlight-importance-high-bg); color:var(--highlight-importance-high-text); padding:0.1em 0.3em; border-radius:0.2em; font-weight:bold; }
        .highlight-importance-medium { background-color:var(--highlight-importance-medium-bg); color:var(--highlight-importance-medium-text); padding:0.1em 0.3em; border-radius:0.2em; font-weight:500; }
        .highlight-importance-low { background-color:var(--highlight-importance-low-bg); color:var(--highlight-importance-low-text); padding:0.1em 0.3em; border-radius:0.2em; font-weight:500; }
        #modelSelectIF, textarea#promptEditor { width: 100%; padding: 0.6rem 0.9rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.95rem; background-color: #fff; color: var(--text-color); font-family: var(--font-family); }
        textarea#promptEditor { min-height: 250px; resize: vertical; margin-bottom: 1rem; }
        textarea#promptEditor:focus, #modelSelectIF:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
        #loadingSection { text-align: center; } #loadingSection p { margin-top: 0.5rem; font-size: 1rem; color: var(--secondary-color); }
        #previewSection .button-group { display: flex; flex-direction: column; gap: 0.6rem; margin-top: 1.2rem; }
        #previewSection #modelSelectIF { margin-bottom: 0.6rem; }
        #resultSection { display: flex; flex-direction: column; }
        .result-actions { display: flex; justify-content: center; align-items: center; margin-top: 1.5rem; gap: 1rem; width: 100%; }
        .result-actions button { flex-grow: 0; min-width: 120px; }
        @media (max-width: 480px) { .result-actions { flex-direction: column; align-items: stretch; } .result-actions button { width: 100%; } }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .history-header h2 { margin-bottom: 0; flex-grow: 1; text-align: center;}
        #clearAllHistoryBtn { font-size: 0.8rem; padding: 0.4rem 0.8rem; flex-shrink: 0; }
        #historyCarouselContainer { overflow-x: auto; white-space: nowrap; padding-bottom: 1rem; margin-bottom: -1rem; }
        #historyCarousel { display: flex; gap: 0.75rem; }
        .history-item-wrapper { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: var(--text-color); width: 110px; position: relative; }
        .history-item { width: 100px; height: 100px; border: 2px solid var(--border-color); border-radius: var(--border-radius); overflow: hidden; cursor: pointer; transition: border-color 0.2s ease, transform 0.2s ease; margin-bottom: 0.25rem; position: relative; }
        .history-item:hover { border-color: var(--primary-color); transform: translateY(-2px); }
        .history-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .history-item-date { font-size: 0.75rem; color: var(--secondary-color); text-align: center; display: block; white-space: normal; line-height: 1.2; width: 100%; }
        .delete-history-item-btn { position: absolute; top: 3px; right: 3px; background-color: rgba(0,0,0,0.4); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; text-align: center; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.2s ease, background-color 0.2s ease; z-index: 10; }
        .history-item-wrapper:hover .delete-history-item-btn { opacity: 1; }
        .delete-history-item-btn:hover { background-color: var(--danger-color); }
        #noHistoryMessage { color: var(--secondary-color); font-style: italic; text-align: center; padding: 1rem 0;}
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s 0.3s linear; }
        .modal-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0s 0s linear; }
        .modal-content { background-color: var(--card-bg); padding: 1.5rem 2rem; border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 450px; text-align: center; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-content p { margin-bottom: 1.5rem; font-size: 1.05rem; line-height: 1.5; }
        .modal-buttons { display: flex; justify-content: center; gap: 1rem; }
        .modal-buttons button { padding: 0.6rem 1.2rem; font-size: 0.9rem; }
        #promptCustomizationBtnContainer { text-align: center; margin-top: 0; }
        #promptSection .prompt-actions { display: flex; justify-content: space-around; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; }
        #promptSection .prompt-actions button { flex-grow: 1; min-width: 150px; }
        #promptStatusIF { font-size: 0.9rem; min-height: 1.3em; margin-top: 1rem; font-weight: 500; text-align: center; } /* Renamed from promptStatus */
        #promptStatusIF.success { color: var(--success-color); } #promptStatusIF.info { color: var(--secondary-color); }
        .main-app-external-buttons-container { width: 100%; max-width: 700px; display: flex; justify-content: center; padding-top: 0; gap: 1rem; }

        /* Advice Generator & Dosage Calculator Common Form Styles */
        .tool-form-group { margin-bottom: 1rem; }
        .tool-form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.95rem; color: var(--text-color); }
        .tool-form-group input[type="text"], .tool-form-group input[type="number"], .tool-form-group select, .tool-form-group textarea { width: 100%; padding: 0.6rem 0.9rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.95rem; background-color: #fff; color: var(--text-color); font-family: var(--font-family); }
        .tool-form-group input[type="text"]:focus, .tool-form-group input[type="number"]:focus, .tool-form-group select:focus, .tool-form-group textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
        .tool-status-message { text-align:center; min-height:1.2em; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem;}
        .tool-action-buttons { display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: center; flex-wrap: wrap;}
        .tool-action-buttons button { min-width: 150px; }
        .tool-loading-indicator { text-align: center; }
        .tool-loading-indicator p { margin-top: 0.5rem; color: var(--secondary-color); font-size: 0.9rem;}
        
        /* Advice Result & Dosage Result Common Styles */
        .result-display-area { padding: 1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); background-color: #fdfdfd; line-height: 1.7; min-height: 80px; font-size: 0.95rem; margin-bottom: 1rem; }
        .result-display-area p { margin-bottom: 0.8em; } .result-display-area p:last-child { margin-bottom: 0; }
        .result-highlight-drugname { background-color: var(--highlight-drug-bg); color: var(--highlight-drug-text); padding: 0.1em 0.3em; border-radius: 0.25rem; font-weight: 600;}
        .result-highlight-term { background-color: #fffbe6; color: #856404; padding: 0.1em 0.3em; border-radius: 0.25rem; font-style: italic;}
        .result-highlight-benefit { background-color: #e6ffe6; color: #155724; padding: 0.1em 0.3em; border-radius: 0.25rem; font-weight: 500;}
        .result-highlight-caution { background-color: #ffe6e6; color: #721c24; padding: 0.1em 0.3em; border-radius: 0.25rem; font-weight: bold;}
        .result-highlight-dosage { background-color: var(--warning-bg-color); color: var(--warning-text-color); padding: 0.1em 0.3em; border-radius: 0.25rem; font-weight: bold;}
        .result-highlight-important-consideration { background-color: #fff3cd; color: var(--warning-text-color); padding: 0.1em 0.3em; border-radius: 0.25rem; font-style: italic;}
        .result-highlight-disclaimer-ai { color: var(--danger-color); font-weight: bold; border: 1px dashed var(--danger-color); padding: 0.2em 0.4em; display: inline-block; margin-top:0.5em; margin-bottom: 0.5em; background-color: #fee; font-size:0.9em; }
        .result-info-bar { margin-bottom: 1rem; font-size: 0.9rem; color: var(--secondary-color); line-height: 1.5; }
        .result-info-bar strong { color: var(--text-color); font-weight: 600; }
        .dosage-experimental-note { font-size: 0.85rem; color: var(--secondary-color); text-align: center; padding: 0.5rem; margin-bottom: 1rem; border: 1px dashed var(--border-color); border-radius: var(--border-radius); background-color: #f9f9f9; }

        /* Drug Quizzer Specific Styles */
        #quizQuestionArea, #quizAnswerArea {
            background-color: #f9f9f9; border: 1px solid var(--border-color);
            padding: 1rem; border-radius: var(--border-radius);
            min-height: 60px; margin-bottom: 1rem; font-size: 1rem; line-height: 1.6;
        }
        #quizAnswerArea { background-color: #e9f7ef; border-color: var(--success-color); }
        #quizAnswerArea[hidden] { display: none; } /* Ensure it's truly hidden */
        #quizzerStatusMessage { text-align: center; margin-bottom: 1rem; min-height: 1.2em; font-weight: 500;}


        [hidden] { display: none !important; }
    </style>
</head>
<body>

    <header id="appHeader">
      <img src="https://www.citypng.com/public/uploads/preview/black-circle-round-question-mark-icon-png-70175169496360405wfyhabkn.png" alt="Logo">
      <h1>Pharmacy Assistant Suite</h1>
    </header>

    <div id="apiKeyConfigArea">
      <h3>API Key Configuration</h3>
      <div class="api-key-form-group">
        <label for="apiKeyInput">OpenAI API Key:</label>
        <input type="password" id="apiKeyInput" placeholder="Enter your OpenAI API Key">
      </div>
      <div class="api-key-buttons">
        <button id="saveApiKeyBtn">Save</button>
        <button id="testApiKeyBtn" class="test-key">Test</button>
        <button id="clearApiKeyBtn" class="secondary">Clear</button>
      </div>
      <p id="apiKeyStatus" class="info"></p>
    </div>

    <div class="app-container">
        <!-- VIEW 0: Landing Page -->
        <div id="landingView">
            <header class="view-header"><h2>Welcome! Select a Tool:</h2></header>
            <section class="view-section">
                <p>Choose an option below to get started.</p>
                <div class="landing-actions">
                    <button id="goToMainAppViewBtn">Interaction Finder</button>
                    <button id="goToAdviceGeneratorFromLandingBtn" class="green">Medication Advice Generator</button>
                    <button id="goToDosageCalculatorFromLandingBtn" class="warning">Dosage Calculator (Experimental)</button>
                    <button id="goToDrugQuizzerFromLandingBtn" class="info">Drug Quizzer</button>
                </div>
            </section>
        </div>

        <!-- VIEW 1: Main Interaction Finder App -->
        <div id="mainAppView" hidden>
            <header class="view-header" style="margin-bottom: 0;"><h2>Prescription Interaction Finder</h2></header>
            <div class="page-container"> 
                <section id="captureSection" class="view-section">
                  <h2>Take a Photo</h2>
                  <p style="margin-bottom: 1.2rem; color: #555; font-size: 0.9rem; text-align: center;">
                    Upload an image of the prescription to analyze.
                  </p>
                  <div style="text-align:center;"> <button id="takePhotoBtn">Take Photo or Upload</button> </div>
                  <input id="fileInputIF" type="file" accept="image/*" capture="environment" hidden>
                </section>
                <section id="historySection" class="view-section" hidden>
                    <div class="history-header"><h2>Recent Analyses</h2><button id="clearAllHistoryBtn" class="danger">Clear All</button></div>
                    <div id="historyCarouselContainer"> <div id="historyCarousel"></div> </div>
                    <p id="noHistoryMessage" hidden>No recent analyses found.</p>
                </section>
                <div id="promptCustomizationBtnContainer" hidden> <button id="goToPromptCustomizationBtn" class="secondary">Prompt Customization</button> </div>
				<br>
                <section id="previewSection" class="view-section" hidden>
                  <h2>Confirm Prescription Image</h2> <img id="previewImg" alt="preview">
                  <div class="button-group">
                    <p style="margin-bottom: 0.5rem; text-align: center; font-size:0.9rem;">Select AI Model:</p>
                    <select id="modelSelectIF"><option value="gpt-4o-mini">GPT-4o-mini (Faster, Good)</option><option value="gpt-4o">GPT-4o (Slower, Best)</option></select>
                    <button id="usePhotoBtn">Use This Photo & Analyze</button> <button id="retakeBtn" class="secondary">Retake or Choose Different</button>
                  </div>
                </section>
                <section id="loadingSection" class="view-section" hidden> <div class="spinner"></div> <p>Analyzing image, please wait…</p> </section>
                <section id="resultSection" class="view-section" hidden>
                  <h2>Analysis Results</h2> <div id="responseBox" role="document" aria-live="polite"></div>
                  <div class="result-actions"><button id="copyResultsBtn">Copy Results</button><button id="restartBtn" class="secondary">Back to Start</button></div>
                </section>
                <section id="promptSection" class="view-section" hidden>
                    <h2>Customize System Prompt</h2>
                    <p style="font-size:0.85rem; color: var(--secondary-color); margin-bottom:1rem;">Modify the instructions given to the AI. Be careful, as significant changes can affect results.</p>
                    <textarea id="promptEditor" rows="10"></textarea>
                    <div class="prompt-actions"><button id="savePromptBtn">Save Prompt</button><button id="resetPromptBtn" class="secondary">Reset to Default</button><button id="returnToMainFromPromptBtn" class="secondary">Return to Main</button></div>
                    <p id="promptStatusIF"></p>
                </section>
            </div>
            <div class="main-app-external-buttons-container">
                <button id="backToLandingViewFromMainBtn" class="secondary">Back to Main Menu</button>
            </div>
        </div>

        <!-- VIEW 2: Advice Generator -->
        <div id="adviceGeneratorView" hidden>
            <header class="view-header"><h2>Generate Medication Advice</h2></header>
            <section class="view-section">
                <div class="tool-form-group">
                    <label for="adviceDrugNameInput">Drug Name:</label>
                    <input type="text" id="adviceDrugNameInput" placeholder="e.g., Amoxicillin" class="tool-input">
                </div>
                <div class="tool-form-group">
                    <label for="adviceModelSelect">Select AI Model:</label>
                    <select id="adviceModelSelect" class="tool-select">
                        <option value="gpt-4o-mini">GPT-4o-mini</option>
                        <option value="gpt-3.5-turbo">GPT-3.5-Turbo</option>
                        <option value="gpt-4o">GPT-4o</option>
                    </select>
                </div>
                <p id="adviceGeneratorStatusMessage" class="tool-status-message"></p>
                <div id="adviceGeneratorLoadingIndicator" class="tool-loading-indicator" hidden>
                    <div class="spinner" style="width:30px; height:30px; border-width:4px;"></div>
                    <p>Generating advice...</p>
                </div>
                <div class="tool-action-buttons">
                    <button id="generateAdviceActualBtn">Generate Advice</button>
                    <button id="returnToLandingViewBtn1" class="secondary">Back to Main Menu</button>
                </div>
            </section>
        </div>

        <!-- VIEW 3: Advice Result -->
        <div id="adviceResultView" hidden>
            <header class="view-header"><h2>Medication Advice Result</h2></header>
            <section class="view-section">
                <div class="result-info-bar">
                    <p><strong>Drug:</strong> <span id="resultAdviceDrugName">N/A</span></p>
                    <p><strong>Model Used:</strong> <span id="resultAdviceModelUsed">N/A</span></p>
                </div>
                <div id="adviceDisplayArea" class="result-display-area"><p style="color: var(--secondary-color);">Loading advice...</p></div>
                <div class="tool-action-buttons">
                    <button id="generateNewAdviceBtn">Generate New Advice</button>
                    <button id="returnToLandingViewBtn2" class="secondary">Back to Main Menu</button>
                </div>
            </section>
        </div>

        <!-- VIEW 4: Dosage Calculator -->
        <div id="dosageCalculatorView" hidden>
            <header class="view-header"><h2>Dosage Calculator (Experimental Tool)</h2></header>
            <section class="view-section">
                <p class="dosage-experimental-note">
                    <strong>Note for Pharmacists:</strong> This tool provides AI-generated dosage information based on general guidelines for experimental and educational purposes. Always verify with official drug monographs and apply professional clinical judgment.
                </p>
                <div class="tool-form-group">
                    <label for="dosageDrugNameInput">Drug Name:</label>
                    <input type="text" id="dosageDrugNameInput" placeholder="e.g., Amoxicillin">
                </div>
                <div class="tool-form-group">
                    <label for="dosagePatientWeightInput">Patient Weight (kg):</label>
                    <input type="number" id="dosagePatientWeightInput" placeholder="e.g., 70" min="0" step="any">
                </div>
                <div class="tool-form-group">
                    <label for="dosagePatientAgeInput">Patient Age (years):</label>
                    <input type="number" id="dosagePatientAgeInput" placeholder="e.g., 35" min="0" step="any">
                </div>
                <div class="tool-form-group">
                    <label for="dosageRenalFunctionInput">Renal Function (e.g., Normal, CrCl value, Description):</label>
                    <input type="text" id="dosageRenalFunctionInput" placeholder="e.g., Normal, CrCl 45 mL/min">
                </div>
                 <div class="tool-form-group">
                    <label for="dosageModelSelect">Select AI Model:</label>
                    <select id="dosageModelSelect">
                        <option value="gpt-4o">GPT-4o (Most Capable)</option>
                        <option value="gpt-4o-mini">GPT-4o-mini (Balanced)</option>
                        <option value="gpt-3.5-turbo">GPT-3.5-Turbo</option>
                    </select>
                </div>
                <p id="dosageCalculatorStatusMessage" class="tool-status-message"></p>
                <div id="dosageCalculatorLoadingIndicator" class="tool-loading-indicator" hidden>
                    <div class="spinner" style="width:30px; height:30px; border-width:4px;"></div>
                    <p>Calculating dosage information...</p>
                </div>
                <div class="tool-action-buttons">
                    <button id="calculateDosageActualBtn">Get Dosage Info</button>
                    <button id="returnToLandingViewBtn3" class="secondary">Back to Main Menu</button>
                </div>
            </section>
        </div>

        <!-- VIEW 5: Dosage Result -->
        <div id="dosageResultView" hidden>
            <header class="view-header"><h2>Dosage Information (Experimental Tool)</h2></header>
            <section class="view-section">
                <p class="dosage-experimental-note" style="margin-top:0;">
                     <strong>Note for Pharmacists:</strong> Review AI-generated information carefully. This is for experimental/educational use and does NOT replace professional judgment or official resources. Verify all details.
                </p>
                <div class="result-info-bar">
                    <p><strong>Drug:</strong> <span id="resultDosageDrugName">N/A</span></p>
                    <p><strong>Weight:</strong> <span id="resultDosageWeight">N/A</span> kg</p>
                    <p><strong>Age:</strong> <span id="resultDosageAge">N/A</span> years</p>
                    <p><strong>Renal Function:</strong> <span id="resultDosageRenal">N/A</span></p>
                    <p><strong>Model Used:</strong> <span id="resultDosageModelUsed">N/A</span></p>
                </div>
                <div id="dosageDisplayArea" class="result-display-area">
                    <p style="color: var(--secondary-color);">Loading dosage information...</p>
                </div>
                <div class="tool-action-buttons">
                    <button id="calculateNewDosageBtn">Calculate New Dosage</button>
                    <button id="returnToLandingViewBtn4" class="secondary">Back to Main Menu</button>
                </div>
            </section>
        </div>
        
        <!-- VIEW 6: Drug Quizzer -->
        <div id="drugQuizzerView" hidden>
            <header class="view-header"><h2>Pharmacy Drug Quizzer</h2></header>
            <section class="view-section">
                <div class="tool-action-buttons" style="margin-bottom: 1.5rem;">
                    <button id="newQuizQuestionBtn">New Question</button>
                </div>
                <div id="quizzerLoadingIndicator" class="tool-loading-indicator" hidden>
                    <div class="spinner" style="width:30px; height:30px; border-width:4px;"></div>
                    <p>Fetching new question...</p>
                </div>
                <p id="quizzerStatusMessage" class="tool-status-message"></p>

                <h3>Question:</h3>
                <div id="quizQuestionArea" class="result-display-area" style="background-color: var(--light-bg);">Click "New Question" to start.</div>
                
                <div class="tool-action-buttons" style="margin-top: 1rem;">
                    <button id="showQuizAnswerBtn" disabled>Show Answer</button>
                </div>

                <h3 id="quizAnswerTitle" hidden style="margin-top: 1.5rem;">Answer:</h3>
                <div id="quizAnswerArea" class="result-display-area" style="background-color: #e9f7ef; border-color: var(--success-color);" hidden></div>

                <div class="tool-action-buttons" style="margin-top: 2rem;">
                    <button id="returnToLandingViewBtn5" class="secondary">Back to Main Menu</button>
                </div>
            </section>
        </div>

    </div> <!-- End of .app-container -->

    <div id="customModalOverlay" class="modal-overlay"> 
      <div class="modal-content"> <p id="modalMessage">Are you sure?</p> <div class="modal-buttons"> <button id="modalConfirmBtn" class="danger">Confirm</button> <button id="modalCancelBtn" class="secondary">Cancel</button> </div> </div>
    </div>

<script>
    // --- Global Constants and Variables ---
    const MAX_HISTORY_ITEMS = 7;
    const HISTORY_STORAGE_KEY = 'interactionFinderHistory';
    const CUSTOM_PROMPT_STORAGE_KEY = 'interactionFinderCustomPrompt';
    const API_KEY_STORAGE_ITEM = 'interactionFinderApiKey';
    const DEFAULT_SYSTEM_PROMPT = `You are a hospital pharmacist analyzing a prescription image. Format your response strictly using Markdown: 1. Start with a heading: '### Detected Medications'. * Under this, use a bulleted list (*). For each drug, use the format: * DRUG{Drug Name} Dosage (e.g., * DRUG{Amoxicillin} 250mg three times daily). 2. Next heading: '### Interactions Found'. * Bulleted list of any drug-drug interactions identified. If none, state "No significant interactions found." For each interaction pair, use DRUG{} for each drug. e.g. * DRUG{Warfarin} and DRUG{Aspirin}. 3. Next heading: '### Consequences & Importance'. * For each interaction, explain its consequences and rate its importance/danger using IMPORTANCE{Severity} (e.g., IMPORTANCE{High}, IMPORTANCE{Medium}, IMPORTANCE{Low}). 4. Final heading: '### Recommendations'. * Provide clear, actionable recommendations. Your primary task is to clearly state the drugs and dosages, then identify and report interactions, their consequences, importance, and your recommendations. Keep it concise. If your view of the prescription is obstructed or unreadable, state this first under a heading '### Readability Issues'. Do not include disclaimers, refuse to answer, or suggest consulting external resources unless absolutely critical for immediate patient safety.`;

    let appApiKey = '';
    let currentActiveView = 'landingView';
    let currentQuizAnswer = ''; 

    // --- Utility Functions ---
    function sel(id){ return document.getElementById(id); }
    const showEl = el => { if(el) el.hidden = false; };
    const hideEl = el => { if(el) el.hidden = true; };

    // --- View Switching Logic ---
    const allViewIds = ['landingView', 'mainAppView', 'adviceGeneratorView', 'adviceResultView', 'dosageCalculatorView', 'dosageResultView', 'drugQuizzerView'];
    const allViewElements = allViewIds.map(id => sel(id));
    function switchToView(viewId) {
        allViewElements.forEach(view => { if(view) hideEl(view); });
        const viewToShow = sel(viewId);
        if (viewToShow) {
            showEl(viewToShow);
            currentActiveView = viewId;
            window.scrollTo(0, 0);
            if (viewId === 'mainAppView' && (!sel('resultSection') || sel('resultSection').hidden)) {
                 if (typeof switchToMainAppSection === 'function') switchToMainAppSection('captureSection');
            }
        } else {
            console.error("Attempted to switch to non-existent view:", viewId);
            const landing = sel('landingView');
            if (landing) showEl(landing); 
            currentActiveView = 'landingView';
        }
    }

    // --- API Key Management (SHARED) ---
    const apiKeyInput = sel('apiKeyInput'), saveApiKeyBtn = sel('saveApiKeyBtn'),
          testApiKeyBtn = sel('testApiKeyBtn'), clearApiKeyBtn = sel('clearApiKeyBtn'),
          apiKeyStatus = sel('apiKeyStatus');
    function updateStatusWithMessage(element, message, type = 'info', duration = 4000) { if (!element) return; element.textContent = message; element.className = type; if (message && duration > 0) { setTimeout(() => { if (element.textContent === message) { element.textContent = ''; element.className = 'info';}}, duration); } }
    function updateApiKeyDisplayStatus(message, type = 'info') { updateStatusWithMessage(apiKeyStatus, message, type); }
    function loadApiKeyFromStorage() { const k=localStorage.getItem(API_KEY_STORAGE_ITEM); if(k){apiKeyInput.value=k;appApiKey=k;updateApiKeyDisplayStatus('API Key loaded.','info');}else{updateApiKeyDisplayStatus('Please enter API Key.','info');} }
    if(saveApiKeyBtn) saveApiKeyBtn.onclick = () => { const k=apiKeyInput.value.trim();if(k&&k.startsWith('sk-')){localStorage.setItem(API_KEY_STORAGE_ITEM,k);appApiKey=k;updateApiKeyDisplayStatus('API Key saved!','success');}else{updateApiKeyDisplayStatus(k?'Invalid Key format.':'Key cannot be empty.','error');} };
    if(testApiKeyBtn) testApiKeyBtn.onclick = async () => { const k=apiKeyInput.value.trim();if(!k){updateApiKeyDisplayStatus('Enter key to test.','error');return;} updateApiKeyDisplayStatus('Testing...','info');try{const r=await fetch('https://api.openai.com/v1/models',{headers:{'Authorization':`Bearer ${k}`}});if(r.ok){updateApiKeyDisplayStatus('Key valid!','success');if(k!==appApiKey){localStorage.setItem(API_KEY_STORAGE_ITEM,k);appApiKey=k;}}else{const e=await r.json();updateApiKeyDisplayStatus(`Test failed: ${e.error?.message||r.statusText}`,'error');}}catch(e){console.error("API Key Test Error:", e); updateApiKeyDisplayStatus('Test failed: Network error.','error');} };
    if(clearApiKeyBtn) clearApiKeyBtn.onclick = () => { localStorage.removeItem(API_KEY_STORAGE_ITEM);apiKeyInput.value='';appApiKey='';updateApiKeyDisplayStatus('API Key cleared.','info'); };

    // --- LANDING VIEW Logic ---
    const goToMainAppViewBtn = sel('goToMainAppViewBtn');
    const goToAdviceGeneratorFromLandingBtn = sel('goToAdviceGeneratorFromLandingBtn');
    const goToDosageCalculatorFromLandingBtn = sel('goToDosageCalculatorFromLandingBtn');
    const goToDrugQuizzerFromLandingBtn = sel('goToDrugQuizzerFromLandingBtn'); 

    if(goToMainAppViewBtn) goToMainAppViewBtn.onclick = () => switchToView('mainAppView');
    if(goToAdviceGeneratorFromLandingBtn) goToAdviceGeneratorFromLandingBtn.onclick = () => switchToView('adviceGeneratorView');
    if(goToDosageCalculatorFromLandingBtn) goToDosageCalculatorFromLandingBtn.onclick = () => switchToView('dosageCalculatorView');
    if(goToDrugQuizzerFromLandingBtn) goToDrugQuizzerFromLandingBtn.onclick = () => {
        switchToView('drugQuizzerView');
        const quizQArea = sel('quizQuestionArea');
        if (quizQArea && quizQArea.textContent === 'Click "New Question" to start.') {
             if (typeof fetchNewQuizQuestion === 'function') fetchNewQuizQuestion();
        }
    };

    // --- MAIN APP VIEW (Interaction Finder) Logic ---
    const takePhotoBtn=sel('takePhotoBtn'), fileInputIF=sel('fileInputIF'), 
          previewImg =sel('previewImg'), usePhotoBtn=sel('usePhotoBtn'), retakeBtn=sel('retakeBtn'),
          modelSelectIF=sel('modelSelectIF'), 
          loadingSec = sel('loadingSection'), responseBox=sel('responseBox'), restartBtn=sel('restartBtn'),
          copyResultsBtn = sel('copyResultsBtn'), historyCarousel=sel('historyCarousel'),
          noHistoryMessage=sel('noHistoryMessage'), historySectionElement=sel('historySection'),
          historyCarouselContainer=sel('historyCarouselContainer'), clearAllHistoryBtn=sel('clearAllHistoryBtn'),
          customModalOverlayIF=sel('customModalOverlay'), modalMessageIF=sel('modalMessage'), // Suffixed to avoid conflict if other modals exist
          modalConfirmBtnIF=sel('modalConfirmBtn'), modalCancelBtnIF=sel('modalCancelBtn'),
          goToPromptCustomizationBtn=sel('goToPromptCustomizationBtn'),
          promptCustomizationBtnContainer=sel('promptCustomizationBtnContainer'),
          promptSectionElement=sel('promptSection'), promptEditor=sel('promptEditor'),
          savePromptBtn=sel('savePromptBtn'), resetPromptBtn=sel('resetPromptBtn'),
          returnToMainFromPromptBtn=sel('returnToMainFromPromptBtn'), promptStatusIF=sel('promptStatusIF'), 
          patientInfoGeneratorBtnExternal = sel('patientInfoGeneratorBtnExternal'),
          backToLandingViewFromMainBtn = sel('backToLandingViewFromMainBtn');
    
    let base64ImageIF=''; let analysisHistoryIF = []; let currentSystemPromptIF = DEFAULT_SYSTEM_PROMPT; let currentConfirmCallbackIF = null;
    const allMainAppPageElementsToToggle = sel('mainAppView') && sel('mainAppView').querySelector('.page-container') ? Array.from(sel('mainAppView').querySelector('.page-container').querySelectorAll('section, div#promptCustomizationBtnContainer')) : [];

    function switchToMainAppSection(targetSectionId){ 
        if(!sel('mainAppView') || !allMainAppPageElementsToToggle.length) return; 
        allMainAppPageElementsToToggle.forEach(el => { if(el) hideEl(el); }); 
        const sectionToShow = sel(targetSectionId); 
        if (sectionToShow) showEl(sectionToShow); 
        if (targetSectionId === 'captureSection') { 
            if(historySectionElement) showEl(historySectionElement); 
            if(promptCustomizationBtnContainer) showEl(promptCustomizationBtnContainer); 
            if (analysisHistoryIF.length > 0) { 
                if(noHistoryMessage) hideEl(noHistoryMessage); 
                if(historyCarouselContainer) showEl(historyCarouselContainer); 
                if(clearAllHistoryBtn) showEl(clearAllHistoryBtn); 
            } else { 
                if(noHistoryMessage) showEl(noHistoryMessage); 
                if(historyCarouselContainer) hideEl(historyCarouselContainer); 
                if(clearAllHistoryBtn) hideEl(clearAllHistoryBtn); 
            } 
        } 
    }
    function updatePromptStatusDisplay(message, type = 'info') { updateStatusWithMessage(promptStatusIF, message, type); } 
    function showCustomConfirmIF(message, onConfirm) { if(!modalMessageIF || !customModalOverlayIF) return; modalMessageIF.textContent = message; currentConfirmCallbackIF = onConfirm; customModalOverlayIF.classList.add('active'); }
    function hideCustomConfirmIF() { if(!customModalOverlayIF) return; customModalOverlayIF.classList.remove('active'); currentConfirmCallbackIF = null; }
    if(modalConfirmBtnIF) modalConfirmBtnIF.onclick = () => { if (currentConfirmCallbackIF) currentConfirmCallbackIF(); hideCustomConfirmIF(); };
    if(modalCancelBtnIF) modalCancelBtnIF.onclick = hideCustomConfirmIF;
    if(customModalOverlayIF) customModalOverlayIF.onclick = (e) => { if (e.target === customModalOverlayIF) hideCustomConfirmIF(); };
    function loadHistoryIF() { const storedHistory = localStorage.getItem(HISTORY_STORAGE_KEY); try { analysisHistoryIF = storedHistory ? JSON.parse(storedHistory) : []; } catch (e) { analysisHistoryIF = []; localStorage.removeItem(HISTORY_STORAGE_KEY); } renderHistoryCarouselIF(); }
    function saveAnalysisToHistoryIF(imgBase64, respHtml, model) { const newItem = { id: Date.now(), imageBase64: imgBase64, responseHtml: respHtml, modelUsed: model, timestamp: Date.now() }; analysisHistoryIF.unshift(newItem); if (analysisHistoryIF.length > MAX_HISTORY_ITEMS) analysisHistoryIF.length = MAX_HISTORY_ITEMS; localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(analysisHistoryIF)); renderHistoryCarouselIF(); }
    function deleteHistoryItemIF(itemId) { showCustomConfirmIF('Delete this analysis from history?', () => { analysisHistoryIF = analysisHistoryIF.filter(item => item.id !== itemId); localStorage.setItem(HISTORY_STORAGE_KEY, JSON.stringify(analysisHistoryIF)); renderHistoryCarouselIF(); }); }
    if(clearAllHistoryBtn) clearAllHistoryBtn.onclick = () => { showCustomConfirmIF('Clear all recent analyses? This cannot be undone.', () => { analysisHistoryIF = []; localStorage.removeItem(HISTORY_STORAGE_KEY); renderHistoryCarouselIF(); }); };
    function renderHistoryCarouselIF() { if(!historyCarousel || !noHistoryMessage || !historyCarouselContainer || !clearAllHistoryBtn) return; historyCarousel.innerHTML = ''; if (analysisHistoryIF.length === 0) { showEl(noHistoryMessage); hideEl(historyCarouselContainer); hideEl(clearAllHistoryBtn); } else { hideEl(noHistoryMessage); showEl(historyCarouselContainer); showEl(clearAllHistoryBtn); analysisHistoryIF.forEach(item => { const w = document.createElement('div'); w.className = 'history-item-wrapper'; const iDiv = document.createElement('div'); iDiv.className = 'history-item'; iDiv.onclick = () => loadAnalysisFromHistoryItemIF(item); const img = document.createElement('img'); img.src = `data:image/jpeg;base64,${item.imageBase64}`; img.alt = `Analyzed ${new Date(item.timestamp).toLocaleDateString()}`; iDiv.appendChild(img); const del = document.createElement('button'); del.className = 'delete-history-item-btn'; del.innerHTML = '×'; del.title = 'Delete'; del.onclick = (e) => { e.stopPropagation(); deleteHistoryItemIF(item.id); }; iDiv.appendChild(del); const date = document.createElement('span'); date.className = 'history-item-date'; const d=new Date(item.timestamp); date.textContent = `${d.getMonth()+1}/${d.getDate()}/${String(d.getFullYear()).slice(-2)} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; w.appendChild(iDiv); w.appendChild(date); historyCarousel.appendChild(w); });}}
    function loadAnalysisFromHistoryItemIF(item) { if(item && responseBox){ responseBox.innerHTML=item.responseHtml; switchToMainAppSection('resultSection'); } }
    function loadCustomPromptIF() { const sp = localStorage.getItem(CUSTOM_PROMPT_STORAGE_KEY); currentSystemPromptIF = sp ? sp : DEFAULT_SYSTEM_PROMPT; if(promptEditor) promptEditor.value = currentSystemPromptIF; if(sp && promptStatusIF) updatePromptStatusDisplay('Custom prompt loaded.','info', 2000); }
    if(goToPromptCustomizationBtn) goToPromptCustomizationBtn.onclick = () => { if(promptEditor) promptEditor.value = currentSystemPromptIF; switchToMainAppSection('promptSection'); };
    if(savePromptBtn) savePromptBtn.onclick = () => { const np = promptEditor.value.trim(); if (np) { currentSystemPromptIF = np; localStorage.setItem(CUSTOM_PROMPT_STORAGE_KEY, np); updatePromptStatusDisplay('Prompt saved successfully!', 'success'); } else { updatePromptStatusDisplay('Prompt cannot be empty. Reverted.', 'error'); promptEditor.value = currentSystemPromptIF; }};
    if(resetPromptBtn) resetPromptBtn.onclick = () => { showCustomConfirmIF("Reset prompt to default?", () => { currentSystemPromptIF = DEFAULT_SYSTEM_PROMPT; promptEditor.value = DEFAULT_SYSTEM_PROMPT; localStorage.removeItem(CUSTOM_PROMPT_STORAGE_KEY); updatePromptStatusDisplay('Prompt reset to default.', 'info'); }); };
    if(returnToMainFromPromptBtn) returnToMainFromPromptBtn.onclick = () => switchToMainAppSection('captureSection');
    if(takePhotoBtn) takePhotoBtn.onclick =()=> { if(fileInputIF) fileInputIF.click(); };
    if(retakeBtn) retakeBtn.onclick =()=> { if(fileInputIF) fileInputIF.click(); };
    if(fileInputIF) fileInputIF.onchange = async () => { const f=fileInputIF.files[0];if(!f)return;try{base64ImageIF=await toBase64IF(f);if(previewImg) previewImg.src='data:image/jpeg;base64,'+base64ImageIF;switchToMainAppSection('previewSection');}catch(e){console.error("File error:",e);alert("Could not load image.");}};
    if(usePhotoBtn) usePhotoBtn.onclick=()=>analyzeImageIF();
    if(restartBtn) restartBtn.onclick=()=> { if(responseBox) responseBox.innerHTML='';if(fileInputIF) fileInputIF.value='';base64ImageIF='';if(previewImg) previewImg.src='';if(modelSelectIF) modelSelectIF.value='gpt-4o-mini';switchToMainAppSection('captureSection');};
    if(copyResultsBtn) copyResultsBtn.onclick = () => { const t=responseBox.textContent;if(navigator.clipboard&&t){navigator.clipboard.writeText(t).then(()=>updateApiKeyDisplayStatus('Results copied!','success', 2000)).catch(e=>updateApiKeyDisplayStatus('Failed to copy.','error', 2000));}};
    function markdownToHtmlIF(mdText) { let h = mdText.replace(/&/g, '&').replace(/</g, '<').replace(/>/g, '>'); h = h.replace(/DRUG\{(.*?)\}/gim, '<span class="highlight-drug">$1</span>'); h = h.replace(/IMPORTANCE\{(High|Medium|Low)\}/gim, (m,s)=>`<span class="highlight-importance-${s.toLowerCase()}">${s}</span>`); h = h.replace(/^### (.*$)/gim, '<h3><span class="section-title-text">$1</span></h3>'); h = h.replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>').replace(/__(.*?)__/gim, '<strong>$1</strong>'); h = h.replace(/\*(.*?)\*/gim, '<em>$1</em>').replace(/_(.*?)_/gim, '<em>$1</em>'); let iL=false; h=h.split('\n').map(l=>{const tL=l.trim();if(tL.match(/^[\*\-]\s+/)){let liC=tL.substring(tL.indexOf(' ')+1).trim();let li=`<li>${liC}</li>`;if(!iL){iL=true;return `<ul>${li}`;}return li;}else{let lR=l;if(iL){lR=`</ul>${lR}`;iL=false;}const tNL=lR.trim();if(tNL&&!tNL.startsWith('<h3')&&!tNL.startsWith('<ul>')&&!tNL.endsWith('</ul>')&&!tNL.startsWith('<p>')&&!tNL.endsWith('</p>')){return `<p>${tNL}</p>`;}return lR;}}).join('\n');if(iL)h+='</ul>';h=h.replace(/<\/ul>\s*<p>/gim,'</ul><p>').replace(/<p>\s*<\/p>/gim,'').replace(/\n\s*\n/g,'\n');return h.trim();}
    function addCopySectionButtonsToResponseBoxIF() { if(!responseBox) return; const hs=responseBox.querySelectorAll('h3');hs.forEach(hE=>{let tS=hE.querySelector('.section-title-text');if(!tS){const tT=hE.textContent;hE.innerHTML='';tS=document.createElement('span');tS.className='section-title-text';tS.textContent=tT;hE.appendChild(tS);}if(hE.querySelector('.copy-section-btn'))return; const cB=document.createElement('button');cB.className='copy-section-btn';cB.textContent='Copy';cB.title=`Copy "${tS.textContent}" section`;hE.appendChild(cB);});}
    if(responseBox) responseBox.addEventListener('click', function(event) { if(event.target.classList.contains('copy-section-btn')){const hE=event.target.closest('h3');if(!hE)return;let cTC=hE.querySelector('.section-title-text').textContent+'\n';let nE=hE.nextElementSibling;while(nE&&nE.tagName!=='H3'){if(nE.tagName==='UL'){Array.from(nE.querySelectorAll('li')).forEach(li=>{cTC+=`• ${li.textContent.trim()}\n`;});}else{cTC+=nE.textContent.trim()+'\n';}nE=nE.nextElementSibling;}if(navigator.clipboard){navigator.clipboard.writeText(cTC.trim()).then(()=>updateApiKeyDisplayStatus('Section copied!','success',2000)).catch(err=>updateApiKeyDisplayStatus('Failed to copy.','error',2000));}}});
    async function analyzeImageIF(){ if(!appApiKey){updateApiKeyDisplayStatus('API Key required.','error');apiKeyInput.focus();if(loadingSec && !loadingSec.hidden)switchToMainAppSection('previewSection');if(responseBox) responseBox.innerHTML='<p style="color:var(--danger-color);">API Key missing.</p>';return;} if(responseBox) responseBox.innerHTML='';switchToMainAppSection('loadingSection'); const sM=modelSelectIF.value; const body={model:sM,messages:[{role:'user',content:[{type:'text',text:currentSystemPromptIF},{type:'image_url',image_url:{url:'data:image/jpeg;base64,'+base64ImageIF}}]}],max_tokens:2000}; try{ const rs=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+appApiKey},body:JSON.stringify(body)}); const d=await rs.json(); if(rs.ok&&d.choices?.[0]?.message?.content){ const rm=d.choices[0].message.content.trim(); const hr=markdownToHtmlIF(rm); responseBox.innerHTML=hr; addCopySectionButtonsToResponseBoxIF(); saveAnalysisToHistoryIF(base64ImageIF, responseBox.innerHTML, sM); }else{ const em=d.error?`${d.error.message} (Code: ${d.error.code})`:'Unknown API error.'; responseBox.innerHTML=`<p style="color:var(--danger-color);">Error: ${em}</p>`; if(d.error?.code==='invalid_api_key'||d.error?.type==='auth_error'){updateApiKeyDisplayStatus('Invalid API Key.','error');appApiKey='';localStorage.removeItem(API_KEY_STORAGE_ITEM);apiKeyInput.value='';}}}catch(e){if(responseBox) responseBox.innerHTML='<p style="color:var(--danger-color);">Request failed. Check network.</p>';} finally{switchToMainAppSection('resultSection');}}
    function toBase64IF(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result.split(',')[1]);r.onerror=rej;r.readAsDataURL(file);});}
    if(patientInfoGeneratorBtnExternal) patientInfoGeneratorBtnExternal.onclick = () => { window.open('info.html', '_blank'); };
    if(backToLandingViewFromMainBtn) backToLandingViewFromMainBtn.onclick = () => switchToView('landingView');

    // --- ADVICE GENERATOR VIEW Logic ---
    const adviceDrugNameInput = sel('adviceDrugNameInput'); const adviceModelSelect = sel('adviceModelSelect'); 
    const generateAdviceActualBtn = sel('generateAdviceActualBtn'); const returnToLandingViewBtn1 = sel('returnToLandingViewBtn1');
    const adviceGeneratorStatusMessage = sel('adviceGeneratorStatusMessage'); const adviceGeneratorLoadingIndicator = sel('adviceGeneratorLoadingIndicator');
    if(adviceModelSelect) adviceModelSelect.value = 'gpt-4o-mini';
    function updateAdviceGeneratorStatus(message, isError = false, duration = 5000) { if (!adviceGeneratorStatusMessage) return; adviceGeneratorStatusMessage.textContent = message; adviceGeneratorStatusMessage.style.color = isError ? 'var(--danger-color)' : 'var(--success-color)'; if (!isError && message && !message.toLowerCase().includes('error') && !message.toLowerCase().includes('valid')) { adviceGeneratorStatusMessage.style.color = 'var(--secondary-color)'; } if (message && duration > 0) { setTimeout(() => { if (adviceGeneratorStatusMessage.textContent === message) adviceGeneratorStatusMessage.textContent = ''; }, duration); } }
    if(generateAdviceActualBtn) generateAdviceActualBtn.onclick = async () => { const drugName = adviceDrugNameInput.value.trim(); const selectedModelDisplay = adviceModelSelect.value; if (!appApiKey) { updateAdviceGeneratorStatus('API Key is missing. Configure it at the top.', true); apiKeyInput.focus(); return; } if (!drugName) { updateAdviceGeneratorStatus('Please enter a drug name.', true); adviceDrugNameInput.focus(); return; } updateAdviceGeneratorStatus(''); if(adviceGeneratorStatusMessage) hideEl(adviceGeneratorStatusMessage); if(adviceGeneratorLoadingIndicator) showEl(adviceGeneratorLoadingIndicator); generateAdviceActualBtn.disabled = true; if(returnToLandingViewBtn1) returnToLandingViewBtn1.disabled = true; let modelForAPI; switch (selectedModelDisplay) { case 'gpt-3.5-turbo': modelForAPI = 'gpt-3.5-turbo'; break; case 'gpt-4o-mini': modelForAPI = 'gpt-4o-mini'; break; case 'gpt-4o': modelForAPI = 'gpt-4o'; break; default: modelForAPI = 'gpt-4o-mini'; } const userPrompt = `Generate a patient-friendly explanation about <span class="result-highlight-drugname">${drugName}</span>. Your task is to clearly inform someone who has never taken this medication about: - What <span class="result-highlight-drugname">${drugName}</span> is and why it is prescribed. - How to correctly take it (including dosage, timing, or any instructions). - Important <span class="result-highlight-term">medical terms</span> and the mechanism of action, if relevant. - Expected <span class="result-highlight-benefit">benefits</span> and outcomes. - Potential <span class="result-highlight-caution">side effects</span>, warnings, and any necessary precautions. Use simple, non-technical language that any patient can understand. Format the output using the following HTML <span> tags: - \`<span class="result-highlight-drugname">${drugName}</span>\` for every mention of the drug. - \`<span class="result-highlight-term">{medical_term}</span>\` for key medical concepts or mechanisms. - \`<span class="result-highlight-benefit">{positive_effect_or_benefit}</span>\` for benefits and improvements. - \`<span class="result-highlight-caution">{caution_side_effect_or_warning}</span>\` for any risks or side effects. Structure the response into 1–3 concise paragraphs without introductory or concluding fluff. If "${drugName}" is not a recognized drug, respond with a short notice asking for a valid name and suggest similar known drugs. If ${drugName} is not quite correct, change it yourself to the correct name.`; try { const response = await fetch('https://api.openai.com/v1/chat/completions', { method: 'POST', headers: {'Content-Type':'application/json','Authorization':`Bearer ${appApiKey}`}, body: JSON.stringify({model: modelForAPI, messages: [{ role: 'user', content: userPrompt }], max_tokens: 450 }) }); const data = await response.json(); if (response.ok && data.choices?.[0]?.message?.content) { const adviceText = data.choices[0].message.content.trim(); displayAdviceResult(drugName, `${selectedModelDisplay} (API: ${modelForAPI})`, adviceText); } else { const errorMsg = data.error ? `${data.error.message} (Code: ${data.error.code})` : 'Unknown API error.'; updateAdviceGeneratorStatus(`Error generating advice: ${errorMsg}`, true, 7000); if(adviceGeneratorStatusMessage) showEl(adviceGeneratorStatusMessage); if(data.error?.code==='invalid_api_key'||data.error?.type==='auth_error'){ updateApiKeyDisplayStatus('Invalid API Key.','error');appApiKey='';localStorage.removeItem(API_KEY_STORAGE_ITEM);apiKeyInput.value='';} } } catch (error) { console.error("Advice Generation Request failed:", error); updateAdviceGeneratorStatus('Request failed. Check network or console for details.', true, 7000); if(adviceGeneratorStatusMessage) showEl(adviceGeneratorStatusMessage); } finally { if(adviceGeneratorLoadingIndicator) hideEl(adviceGeneratorLoadingIndicator); generateAdviceActualBtn.disabled = false; if(returnToLandingViewBtn1) returnToLandingViewBtn1.disabled = false; } };
    if(returnToLandingViewBtn1) returnToLandingViewBtn1.onclick = () => switchToView('landingView');

    // --- ADVICE RESULT VIEW Logic ---
    const resultAdviceDrugName = sel('resultAdviceDrugName'); const resultAdviceModelUsed = sel('resultAdviceModelUsed'); 
    const adviceDisplayArea = sel('adviceDisplayArea'); const generateNewAdviceBtn = sel('generateNewAdviceBtn');
    const returnToLandingViewBtn2 = sel('returnToLandingViewBtn2');
    function displayAdviceResult(drug, model, adviceHTML) { if(resultAdviceDrugName) resultAdviceDrugName.textContent = drug; if(resultAdviceModelUsed) resultAdviceModelUsed.textContent = model; if(adviceDisplayArea) adviceDisplayArea.innerHTML = adviceHTML; switchToView('adviceResultView');}
    if(generateNewAdviceBtn) generateNewAdviceBtn.onclick = () => switchToView('adviceGeneratorView');
    if(returnToLandingViewBtn2) returnToLandingViewBtn2.onclick = () => switchToView('landingView');

    // --- DOSAGE CALCULATOR VIEW Logic ---
    const dosageDrugNameInput = sel('dosageDrugNameInput'); const dosagePatientWeightInput = sel('dosagePatientWeightInput');
    const dosagePatientAgeInput = sel('dosagePatientAgeInput'); const dosageRenalFunctionInput = sel('dosageRenalFunctionInput');
    const dosageModelSelect = sel('dosageModelSelect'); const calculateDosageActualBtn = sel('calculateDosageActualBtn');
    const returnToLandingViewBtn3 = sel('returnToLandingViewBtn3'); 
    const dosageCalculatorStatusMessage = sel('dosageCalculatorStatusMessage'); const dosageCalculatorLoadingIndicator = sel('dosageCalculatorLoadingIndicator');
    if(dosageModelSelect) dosageModelSelect.value = 'gpt-4o'; 
    function updateDosageCalculatorStatus(message, isError = false, duration = 7000) { if (!dosageCalculatorStatusMessage) return; dosageCalculatorStatusMessage.textContent = message; dosageCalculatorStatusMessage.style.color = isError ? 'var(--danger-color)' : 'var(--success-color)'; if (!isError && message && !message.toLowerCase().includes('error')) { dosageCalculatorStatusMessage.style.color = 'var(--secondary-color)'; } if (message && duration > 0) { setTimeout(() => { if (dosageCalculatorStatusMessage.textContent === message) dosageCalculatorStatusMessage.textContent = ''; }, duration); } }
    if(calculateDosageActualBtn) calculateDosageActualBtn.onclick = async () => {
        const drugName = dosageDrugNameInput.value.trim(); const weight = dosagePatientWeightInput.value.trim();
        const age = dosagePatientAgeInput.value.trim(); const renal = dosageRenalFunctionInput.value.trim();
        const selectedModel = dosageModelSelect.value;
        if (!appApiKey) { updateDosageCalculatorStatus('API Key is missing. Configure it at the top.', true); if(apiKeyInput) apiKeyInput.focus(); return; }
        if (!drugName) { updateDosageCalculatorStatus('Drug Name is required.', true); if(dosageDrugNameInput) dosageDrugNameInput.focus(); return; }
        if (!weight) { updateDosageCalculatorStatus('Patient Weight is required.', true); if(dosagePatientWeightInput) dosagePatientWeightInput.focus(); return; }
        if (!age) { updateDosageCalculatorStatus('Patient Age is required.', true); if(dosagePatientAgeInput) dosagePatientAgeInput.focus(); return; }
        updateDosageCalculatorStatus(''); if(dosageCalculatorStatusMessage) hideEl(dosageCalculatorStatusMessage); if(dosageCalculatorLoadingIndicator) showEl(dosageCalculatorLoadingIndicator); calculateDosageActualBtn.disabled = true; if(returnToLandingViewBtn3) returnToLandingViewBtn3.disabled = true;
        const prompt = `You are an AI assistant providing GENERAL INFORMATION based on common drug dosage guidelines for EXPERIMENTAL AND EDUCATIONAL PURPOSES for HOSPITAL PHARMACISTS. This information is NOT for direct patient use or clinical decision-making without professional verification. Drug Name: ${drugName}. Patient Weight: ${weight} kg. Patient Age: ${age} years. Renal Function (User Provided): "${renal}". Based on generally accepted dosage guidelines for the drug '${drugName}', provide TYPICAL dosage information for a patient with these characteristics. Your response should be geared towards a pharmacist audience. Your response should aim to include: 1. The typical dosage calculation or range (e.g., "X mg/kg/day divided Y times" or "Z mg every X hours"). Clearly show how the weight and age might be used if applicable. 2. Any common frequency or administration routes. 3. Mention any standard adjustments or special considerations based on age (e.g. pediatric, geriatric), weight, or the provided renal function description. If renal description is vague (e.g. "bad kidneys"), state that specific advice needs proper clinical assessment of renal function (e.g. CrCl/eGFR). 4. State any common maximum daily doses if widely known for this drug and context. 5. A brief concluding note: "<span class="result-highlight-disclaimer-ai">Reminder: This AI-generated information is for experimental/educational review by pharmacists and requires verification against official drug monographs and clinical judgment.</span>" 6. If the drug name is not recognized or if the provided parameters are clearly insufficient or outside a typical range for providing any general guideline, clearly state that and explain why. DO NOT INVENT INFORMATION OR DOSAGES. Format the response using these HTML <span> tags for emphasis: - Drug name: <span class="result-highlight-drugname">${drugName}</span> - Calculated or typical dosage values/ranges: <span class="result-highlight-dosage">{dosage_value}</span> - Important considerations, warnings, or adjustments: <span class="result-highlight-important-consideration">{consideration_text}</span> - The concluding reminder note text itself: <span class="result-highlight-disclaimer-ai">{reminder_text_as_above}</span>`;
        try { const response = await fetch('https://api.openai.com/v1/chat/completions', { method: 'POST', headers: {'Content-Type':'application/json','Authorization':`Bearer ${appApiKey}`}, body: JSON.stringify({model: selectedModel, messages: [{ role: 'user', content: prompt }], max_tokens: 700 }) }); const data = await response.json(); if (response.ok && data.choices?.[0]?.message?.content) { const dosageInfoHTML = data.choices[0].message.content.trim(); displayDosageResult(drugName, weight, age, renal, `${selectedModel} (API: ${selectedModel})`, dosageInfoHTML); } else { const errorMsg = data.error ? `${data.error.message} (Code: ${data.error.code})` : 'Unknown API error.'; updateDosageCalculatorStatus(`Error generating dosage info: ${errorMsg}`, true); if(dosageCalculatorStatusMessage) showEl(dosageCalculatorStatusMessage); if(data.error?.code==='invalid_api_key'||data.error?.type==='auth_error'){ updateApiKeyDisplayStatus('Invalid API Key.','error');appApiKey='';localStorage.removeItem(API_KEY_STORAGE_ITEM);apiKeyInput.value='';} } } catch (error) { console.error("Dosage Calculation Request failed:", error); updateDosageCalculatorStatus('Request failed. Check network or console for details.', true); if(dosageCalculatorStatusMessage) showEl(dosageCalculatorStatusMessage); } finally { if(dosageCalculatorLoadingIndicator) hideEl(dosageCalculatorLoadingIndicator); calculateDosageActualBtn.disabled = false; if(returnToLandingViewBtn3) returnToLandingViewBtn3.disabled = false; } };
    if(returnToLandingViewBtn3) returnToLandingViewBtn3.onclick = () => switchToView('landingView');

    // --- DOSAGE RESULT VIEW Logic ---
    const resultDosageDrugName = sel('resultDosageDrugName'); const resultDosageWeight = sel('resultDosageWeight');
    const resultDosageAge = sel('resultDosageAge'); const resultDosageRenal = sel('resultDosageRenal');
    const resultDosageModelUsed = sel('resultDosageModelUsed'); const dosageDisplayArea = sel('dosageDisplayArea');
    const calculateNewDosageBtn = sel('calculateNewDosageBtn'); const returnToLandingViewBtn4 = sel('returnToLandingViewBtn4');
    function displayDosageResult(drug, weight, age, renal, model, dosageHTML) { if(resultDosageDrugName) resultDosageDrugName.textContent = drug; if(resultDosageWeight) resultDosageWeight.textContent = weight; if(resultDosageAge) resultDosageAge.textContent = age; if(resultDosageRenal) resultDosageRenal.textContent = renal || "Not specified"; if(resultDosageModelUsed) resultDosageModelUsed.textContent = model; if(dosageDisplayArea) dosageDisplayArea.innerHTML = dosageHTML; switchToView('dosageResultView');}
    if(calculateNewDosageBtn) calculateNewDosageBtn.onclick = () => switchToView('dosageCalculatorView');
    if(returnToLandingViewBtn4) returnToLandingViewBtn4.onclick = () => switchToView('landingView');

    // --- DRUG QUIZZER VIEW Logic ---
    const newQuizQuestionBtn = sel('newQuizQuestionBtn');
    const showQuizAnswerBtn = sel('showQuizAnswerBtn');
    const quizQuestionArea = sel('quizQuestionArea');
    const quizAnswerArea = sel('quizAnswerArea');
    const quizAnswerTitle = sel('quizAnswerTitle');
    const quizzerLoadingIndicator = sel('quizzerLoadingIndicator');
    const quizzerStatusMessage = sel('quizzerStatusMessage');
    const returnToLandingViewBtn5 = sel('returnToLandingViewBtn5');

    function updateQuizzerStatus(message, isError = false, duration = 4000) { if (!quizzerStatusMessage) return; quizzerStatusMessage.textContent = message; quizzerStatusMessage.style.color = isError ? 'var(--danger-color)' : 'var(--success-color)'; if (!isError && message && !message.toLowerCase().includes('error')) { quizzerStatusMessage.style.color = 'var(--secondary-color)'; } if (message && duration > 0) { setTimeout(() => { if (quizzerStatusMessage.textContent === message) quizzerStatusMessage.textContent = ''; }, duration); } }
    async function fetchNewQuizQuestion() {
        if (!appApiKey) {
            updateQuizzerStatus('API Key is missing. Configure it at the top.', true);
            if(apiKeyInput) apiKeyInput.focus();
            return;
        }

        updateQuizzerStatus('');
        if(quizzerLoadingIndicator) showEl(quizzerLoadingIndicator);
        if(newQuizQuestionBtn) newQuizQuestionBtn.disabled = true;
        if(showQuizAnswerBtn) showQuizAnswerBtn.disabled = true;
        if(quizQuestionArea) quizQuestionArea.textContent = 'Fetching question...';
        if(quizAnswerArea) { hideEl(quizAnswerArea); quizAnswerArea.textContent = ''; }
        if(quizAnswerTitle) hideEl(quizAnswerTitle);
        currentQuizAnswer = '';

        // Add a changing element to the prompt
        const requestNonce = Date.now(); // Using timestamp for variability

        const prompt = `
        You are a helpful assistant for creating pharmacy quiz questions.
        Nonce: ${requestNonce} {/* This part changes each time, encouraging a new response */}
        Generate a single, concise, pharmacy-related quiz question and its corresponding answer.
        The question should be suitable for a pharmacist or pharmacy student living in The Netherlands. Avoid repeating questions.
        Topics can include pharmacology, calculations, clinical scenarios, law, or drug information.
        Provide the output STRICTLY in JSON format with two keys: "question" and "answer".
        Example:
        {
          "question": "What is the primary mechanism of action for metformin?",
          "answer": "Metformin primarily works by decreasing hepatic glucose production, decreasing intestinal absorption of glucose, and improving insulin sensitivity by increasing peripheral glucose uptake and utilization."
        }
        Another example:
        {
          "question": "A patient is prescribed Drug X 5mg BID. How many tablets will they need for a 30-day supply if Drug X is available as 5mg tablets?",
          "answer": "60 tablets (5mg twice a day = 2 tablets/day. 2 tablets/day * 30 days = 60 tablets)."
        }`;

        try {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${appApiKey}` },
                body: JSON.stringify({
                    model: "gpt-4o-mini", 
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 1.0, // Increased temperature for more variability
                    max_tokens: 250,
                    response_format: { type: "json_object" } 
                })
            });
            // ... (rest of the function: parsing JSON, error handling, UI updates) ...
            const data = await response.json();
            if (response.ok && data.choices?.[0]?.message?.content) {
                try { 
                    const qaPair = JSON.parse(data.choices[0].message.content); 
                    if (qaPair.question && qaPair.answer) { 
                        if(quizQuestionArea) quizQuestionArea.textContent = qaPair.question; 
                        currentQuizAnswer = qaPair.answer; 
                        if(showQuizAnswerBtn) {showQuizAnswerBtn.disabled = false; showQuizAnswerBtn.textContent = "Show Answer";} 
                    } else { 
                        throw new Error("AI response did not contain 'question' or 'answer'."); 
                    }
                } catch (parseError) { 
                    console.error("Error parsing AI JSON response:", parseError, "Raw content:", data.choices[0].message.content); 
                    updateQuizzerStatus('Error processing AI response format. Retrying...', true, 5000); 
                    if(quizQuestionArea) quizQuestionArea.textContent = 'Could not load question. Try "New Question".'; 
                }
            } else { 
                const errorMsg = data.error ? `${data.error.message} (Code: ${data.error.code})` : 'Unknown API error.'; 
                updateQuizzerStatus(`Error: ${errorMsg}`, true); 
                if(quizQuestionArea) quizQuestionArea.textContent = 'Failed to fetch question.'; 
                if(data.error?.code==='invalid_api_key'||data.error?.type==='auth_error'){ updateApiKeyDisplayStatus('Invalid API Key.','error');appApiKey='';localStorage.removeItem(API_KEY_STORAGE_ITEM);apiKeyInput.value='';} 
            }
        } catch (error) { 
            console.error("Fetch Quiz Question failed:", error); 
            updateQuizzerStatus('Request failed. Check network.', true); 
            if(quizQuestionArea) quizQuestionArea.textContent = 'Network error.';
        } finally { 
            if(quizzerLoadingIndicator) hideEl(quizzerLoadingIndicator); 
            if(newQuizQuestionBtn) newQuizQuestionBtn.disabled = false; 
        }
    }
    if(newQuizQuestionBtn) newQuizQuestionBtn.onclick = fetchNewQuizQuestion;
    if(showQuizAnswerBtn) showQuizAnswerBtn.onclick = () => { if (currentQuizAnswer) { if(quizAnswerArea) quizAnswerArea.textContent = currentQuizAnswer; if(quizAnswerArea) showEl(quizAnswerArea); if(quizAnswerTitle) showEl(quizAnswerTitle); showQuizAnswerBtn.disabled = true; showQuizAnswerBtn.textContent = "Answer Shown"; } else { if(quizAnswerArea) quizAnswerArea.textContent = "No answer available for the current question."; if(quizAnswerArea) showEl(quizAnswerArea); if(quizAnswerTitle) showEl(quizAnswerTitle); }};
    if(returnToLandingViewBtn5) returnToLandingViewBtn5.onclick = () => switchToView('landingView');

    // --- Initial Application Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        loadApiKeyFromStorage();
        if (typeof loadHistoryIF === 'function') loadHistoryIF(); 
        if (typeof loadCustomPromptIF === 'function') loadCustomPromptIF();
        switchToView('landingView');
    });
</script>
</body>
</html>