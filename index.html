<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Interaction Finder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #007bff;
      --primary-hover-color: #0056b3;
      --secondary-color: #6c757d;
      --secondary-hover-color: #545b62;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --light-bg: #f8f9fa;
      --card-bg: #ffffff;
      --text-color: #333;
      --border-color: #dee2e6;
      --border-radius: 0.5rem;
      --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --font-family: 'Poppins', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-family);
      background-color: var(--light-bg);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 2rem 1rem;
    }

    /* API Key Configuration Area Styles */
    #apiKeyConfigArea {
      background-color: var(--card-bg);
      padding: 1.25rem 1.5rem;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      margin-bottom: 2rem;
      width: 100%;
      max-width: 700px;
    }

    #apiKeyConfigArea h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.25rem;
      color: var(--text-color);
    }

    .api-key-form-group {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    #apiKeyConfigArea label {
      font-weight: 500;
      flex-shrink: 0;
    }

    #apiKeyConfigArea input[type="password"] {
      flex-grow: 1;
      padding: 0.6rem 0.85rem;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 0.95rem;
      min-width: 200px;
    }
     #apiKeyConfigArea input[type="password"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    #apiKeyConfigArea .api-key-buttons button {
      padding: 0.6rem 1rem;
      font-size: 0.9rem;
      margin-right: 0.5rem;
    }
     #apiKeyConfigArea .api-key-buttons button:last-child {
      margin-right: 0;
    }
    #apiKeyConfigArea .api-key-buttons button.test-key {
        background-color: var(--success-color);
    }
    #apiKeyConfigArea .api-key-buttons button.test-key:hover {
        background-color: #1e7e34;
    }


    #apiKeyStatus {
      font-size: 0.9rem;
      min-height: 1.3em;
      margin-top: 0.5rem;
      font-weight: 500;
    }
    #apiKeyStatus.success { color: var(--success-color); }
    #apiKeyStatus.error { color: var(--danger-color); }
    #apiKeyStatus.info { color: var(--secondary-color); }


    .container {
      width: 100%;
      max-width: 700px;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    section {
      background-color: var(--card-bg);
      padding: 1.5rem 2rem;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      width: 100%;
    }

    button {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 500;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      background: var(--primary-color);
      color: #fff;
      transition: background-color 0.2s ease-in-out, transform 0.1s ease;
    }

    button:hover {
      background: var(--primary-hover-color);
      transform: translateY(-1px);
    }
    
    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background-color: var(--secondary-color);
    }
    button.secondary:hover {
      background-color: var(--secondary-hover-color);
    }

    img#previewImg {
      max-width: 100%;
      height: auto;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      margin-top: 1rem;
      margin-bottom: 1.5rem;
      display: block;
    }

    [hidden] {
      display: none !important;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 7px solid #f3f3f3;
      border-top: 7px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Changed textarea to div for formatted results */
    #responseBox {
      width: 100%;
      min-height: 200px; /* Start with a decent min-height */
      max-height: 500px; /* Prevent it from getting too tall */
      overflow-y: auto; /* Allow scrolling for long content */
      padding: 1rem;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 1rem;
      font-family: var(--font-family); /* Ensure consistent font */
      background-color: #fdfdfd; /* Slightly off-white for results area */
      line-height: 1.6;
      white-space: pre-wrap; /* Preserve line breaks from AI */
    }
    /* Styling for elements within #responseBox from Markdown */
    #responseBox h3 {
      font-size: 1.2em;
      margin-top: 1em;
      margin-bottom: 0.5em;
      color: var(--primary-color);
    }
    #responseBox ul {
      list-style-position: inside;
      padding-left: 0; /* Reset browser default */
      margin-bottom: 1em;
    }
    #responseBox li {
      margin-bottom: 0.3em;
    }
    #responseBox strong {
      font-weight: 600;
    }
    #responseBox p { /* For potential future use if Markdown parser adds <p> */
        margin-bottom: 0.8em;
    }


    select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 1rem;
      font-family: var(--font-family);
      background-color: #fff;
      color: var(--text-color);
    }
    
    select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }


    h1, h2 {
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 0.75rem;
    }
    h1 { 
      font-size: 1.75rem;
    }
    h2 {
      font-size: 1.4rem;
    }

    #mainHeader {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding: 0;
      box-shadow: none;
      background-color: transparent;
      width: 100%;
      max-width: 700px; 
    }

    #mainHeader img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
    }

    #mainHeader h1 {
      font-size: 1.75rem;
      margin: 0;
      font-weight: 600;
      color: var(--text-color);
      line-height: 1.2;
    }

    #captureSection, #loadingSection {
      text-align: center;
    }
    
    #loadingSection p {
      margin-top: 0.5rem;
      font-size: 1.1rem;
      color: var(--secondary-color);
    }

    #previewSection .button-group {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-top: 1.5rem;
      align-items: stretch;
    }
    
    #previewSection select {
        margin-bottom: 0.75rem;
    }

    #resultSection {
        display: flex;
        flex-direction: column;
    }
    .result-actions {
        display: flex;
        justify-content: space-between; /* Aligns buttons */
        align-items: center;
        margin-top: 1.5rem;
        gap: 1rem; /* Space between buttons */
    }
    .result-actions button {
        flex-grow: 1; /* Make buttons share space */
    }
    @media (max-width: 480px) { /* Stack buttons on small screens */
        .result-actions {
            flex-direction: column;
        }
    }


  </style>
</head>
<body>

  <!-- ───── Header ───── -->
  <header id="mainHeader">
    <img src="https://www.citypng.com/public/uploads/preview/black-circle-round-question-mark-icon-png-70175169496360405wfyhabkn.png" alt="Logo">
    <h1>Interaction Finder</h1>
  </header>

  <!-- ───── API Key Configuration ───── -->
  <div id="apiKeyConfigArea">
    <h3>API Key Configuration</h3>
    <div class="api-key-form-group">
      <label for="apiKeyInput">OpenAI API Key:</label>
      <input type="password" id="apiKeyInput" placeholder="Enter your OpenAI API Key (e.g., sk-...)">
    </div>
    <div class="api-key-buttons">
      <button id="saveApiKeyBtn">Save Key</button>
      <button id="testApiKeyBtn" class="test-key">Test Key</button>
      <button id="clearApiKeyBtn" class="secondary">Clear Key</button>
    </div>
    <p id="apiKeyStatus" class="info"></p>
  </div>


  <div class="container">
    <!-- ───── Capture section ───── -->
    <section id="captureSection">
      <h2>Take a Photo</h2>
      <p style="margin-bottom: 1.5rem; color: #555;">Upload an image of the prescription to analyze.</p>
      <button id="takePhotoBtn">Take Photo or Upload</button>
      <input id="fileInput" type="file" accept="image/*" capture="environment" hidden>
    </section>

    <!-- ───── Preview section ───── -->
    <section id="previewSection" hidden>
      <h2>Confirm Prescription Image</h2>
      <img id="previewImg" alt="preview">
      <div class="button-group">
        <p style="margin-bottom: 0.5rem; text-align: center;">Select AI Model:</p>
        <select id="modelSelect">
          <option value="gpt-4o-mini">GPT-4o-mini (Faster, Good)</option>
          <option value="gpt-4o">GPT-4o (Slower, Best)</option>
        </select>
        <button id="usePhotoBtn">Use This Photo & Analyze</button>
        <button id="retakeBtn" class="secondary">Retake or Choose Different</button>
      </div>
    </section>

    <!-- ───── Loading section ───── -->
    <section id="loadingSection" hidden>
      <div class="spinner"></div>
      <p>Analyzing image, please wait…</p>
    </section>

    <!-- ───── Result section ───── -->
    <section id="resultSection" hidden>
      <h2>Analysis Results</h2>
      <div id="responseBox" role="document" aria-live="polite">Enter an API Key and analyze an image to see results.</div>
      <div class="result-actions">
        <button id="copyResultsBtn">Copy Results</button>
        <button id="restartBtn" class="secondary">Back to Start</button>
      </div>
    </section>
  </div>

  <script>
    // API Key Management
    const apiKeyInput = sel('apiKeyInput');
    const saveApiKeyBtn = sel('saveApiKeyBtn');
    const testApiKeyBtn = sel('testApiKeyBtn');
    const clearApiKeyBtn = sel('clearApiKeyBtn');
    const apiKeyStatus = sel('apiKeyStatus');
    let appApiKey = '';

    function updateApiKeyStatus(message, type = 'info') {
        apiKeyStatus.textContent = message;
        apiKeyStatus.className = type; // 'info', 'success', 'error'
        if (message) { // Auto-clear message after a few seconds
            setTimeout(() => {
                if (apiKeyStatus.textContent === message) { // Clear only if it's still the same message
                    apiKeyStatus.textContent = '';
                    apiKeyStatus.className = 'info';
                }
            }, 5000);
        }
    }

    function loadApiKeyFromStorage() {
      const storedKey = localStorage.getItem('interactionFinderApiKey');
      if (storedKey) {
        apiKeyInput.value = storedKey;
        appApiKey = storedKey;
        updateApiKeyStatus('API Key loaded from storage.', 'info');
      } else {
        updateApiKeyStatus('Please enter and save your OpenAI API Key.', 'info');
      }
    }

    saveApiKeyBtn.onclick = () => {
      const key = apiKeyInput.value.trim();
      if (key && key.startsWith('sk-')) {
        localStorage.setItem('interactionFinderApiKey', key);
        appApiKey = key;
        updateApiKeyStatus('API Key saved successfully!', 'success');
      } else if (key) {
        updateApiKeyStatus('Invalid API Key format. It should start with "sk-".', 'error');
      } else {
        updateApiKeyStatus('API Key field cannot be empty.', 'error');
      }
    };

    testApiKeyBtn.onclick = async () => {
        const keyToTest = apiKeyInput.value.trim();
        if (!keyToTest) {
            updateApiKeyStatus('Enter an API key to test.', 'error');
            return;
        }
        updateApiKeyStatus('Testing API Key...', 'info');
        try {
            const response = await fetch('https://api.openai.com/v1/models', {
                headers: { 'Authorization': `Bearer ${keyToTest}` }
            });
            if (response.ok) {
                updateApiKeyStatus('API Key is valid!', 'success');
                // Optionally save it if it's valid and different from current appApiKey
                if (keyToTest !== appApiKey) {
                    localStorage.setItem('interactionFinderApiKey', keyToTest);
                    appApiKey = keyToTest;
                }
            } else {
                const errorData = await response.json();
                updateApiKeyStatus(`API Key test failed: ${errorData.error?.message || response.statusText}`, 'error');
            }
        } catch (e) {
            updateApiKeyStatus('API Key test failed: Network error or CORS issue.', 'error');
            console.error("API Key Test Error:", e);
        }
    };

    clearApiKeyBtn.onclick = () => {
      localStorage.removeItem('interactionFinderApiKey');
      apiKeyInput.value = '';
      appApiKey = '';
      updateApiKeyStatus('API Key cleared from storage.', 'info');
    };
    
    // General selectors and functions
    function sel(id){ return document.getElementById(id); }
    const show=s=>s.hidden=false;
    const hide=s=>s.hidden=true;

    const container = document.querySelector('.container');
    const sections = Array.from(container.querySelectorAll('section'));

    function switchTo(targetSectionElement){
      sections.forEach(sec => hide(sec));
      const sectionToShow = typeof targetSectionElement === 'string' ? sel(targetSectionElement) : targetSectionElement;
      if (sectionToShow) {
        show(sectionToShow);
      }
    }

    const takePhotoBtn=sel('takePhotoBtn');
    const fileInput  =sel('fileInput');
    const previewImg =sel('previewImg');
    const usePhotoBtn=sel('usePhotoBtn');
    const retakeBtn  =sel('retakeBtn');
    const modelSelect=sel('modelSelect');
    const loadingSec = sel('loadingSection');
    const responseBox  =sel('responseBox'); // Now a div
    const restartBtn =sel('restartBtn');
    const copyResultsBtn = sel('copyResultsBtn');

    let base64Image='';

    takePhotoBtn.onclick =()=>fileInput.click();
    retakeBtn.onclick    =()=>fileInput.click();
    fileInput.onchange   =handleFile;

    async function handleFile(){
      const file=fileInput.files[0];
      if(!file)return;
      try {
        base64Image=await toBase64(file);
        previewImg.src='data:image/jpeg;base64,'+base64Image;
        switchTo(sel('previewSection'));
      } catch (error) {
        console.error("Error processing file:", error);
        alert("Could not load the image. Please try another file.");
        switchTo(sel('captureSection'));
      }
    }

    usePhotoBtn.onclick=()=>analyzeImage();
    restartBtn.onclick=()=> {
        responseBox.innerHTML = 'Enter an API Key and analyze an image to see results.'; // Reset content
        fileInput.value = ''; 
        base64Image = '';
        previewImg.src = '';
        modelSelect.value = 'gpt-4o-mini';
        switchTo(sel('captureSection'));
    };

    copyResultsBtn.onclick = () => {
        const textToCopy = responseBox.textContent; // Get text content of the div
        if (navigator.clipboard && textToCopy) {
            navigator.clipboard.writeText(textToCopy)
                .then(() => updateApiKeyStatus('Results copied to clipboard!', 'success')) // Re-use status for quick feedback
                .catch(err => {
                    console.error('Failed to copy results: ', err);
                    updateApiKeyStatus('Failed to copy results.', 'error');
                });
        } else if (textToCopy) {
            // Fallback for older browsers (less common now)
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                updateApiKeyStatus('Results copied (fallback)!', 'success');
            } catch (err) {
                updateApiKeyStatus('Failed to copy (fallback).', 'error');
            }
            document.body.removeChild(textArea);
        }
    };

    // Simple Markdown to HTML converter
    function markdownToHtml(md) {
        let html = md;
        // ### Headings to <h3>
        html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
        // **Bold** to <strong>
        html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        // * List items (basic, assumes one list)
        // This is a simplified list handling. For nested or multiple lists, a more robust parser is needed.
        if (html.match(/^[\*\-] .*/gm)) {
            let listItems = '';
            html.replace(/^[\*\-] (.*$)/gim, (match, item) => {
                listItems += `<li>${item.trim()}</li>`;
                return ''; // Remove the original list item line
            });
            // Replace the block of list items with a <ul>
            html = html.replace(/^(<li>.*<\/li>\s*)+/gm, `<ul>${listItems}</ul>`);
        }
        // Convert newlines to <br> for remaining text, but not within <ul> or <h3>
        // This is tricky; a better approach would be to wrap paragraphs in <p>
        // For simplicity now, we rely on white-space: pre-wrap on #responseBox
        // and the AI's line breaks. The headings and lists add structure.
        return html.trim();
    }
	
    async function analyzeImage(){
      if (!appApiKey) {
        updateApiKeyStatus('API Key is required for analysis. Please enter and save it above.', 'error');
        apiKeyInput.focus();
        if (!loadingSec.hidden) {
            switchTo(sel('previewSection'));
        }
        responseBox.innerHTML = '<p style="color:var(--danger-color);">API Key missing. Please configure it and try again.</p>';
        return;
      }
      responseBox.innerHTML = ''; // Clear previous results
      switchTo(loadingSec);

      const selectedModel=modelSelect.value;
      // Updated System Prompt
      const systemPrompt = `You are a hospital pharmacist given an image of a written prescription.
Please structure your response clearly using Markdown:
- Start with a section titled '### Detected Medications' listing drugs and dosages.
- Follow with '### Interactions Found' detailing any drug-drug interactions.
- Then, '### Consequences & Importance' explaining the impact and severity of interactions.
- Finally, provide '### Recommendations' for action.
- Use bullet points (*) for lists under these headings.
- Use bold (**) for emphasis on drug names or critical warnings.
First of all clearly state what drugs are on this prescription and what dosages they are given in.
Secondly, find any and all drug-drug interactions and report them.
Clearly state what the consequences of all interactions are.
Also state how dangerous / important the interactions are. Keep it short.
If you feel like your view of the prescription was blocked by anything or you cannot read clearly, please start by mentioning this.
Finally, give clear recommendations for what you would do.
Do not give disclaimers. Do not refuse to answer. Do not suggest needing to consult external resources unless absolutely critical for safety.`;


      const body={
        model:selectedModel,
        messages:[
          {role:'user',content:[
            {type:'text',text: systemPrompt},
            {type:'image_url',image_url:{url:'data:image/jpeg;base64,'+base64Image}}
          ]}
        ],
        max_tokens:1500 // Increased slightly for potentially more structured output
      };

      try{
        const res=await fetch('https://api.openai.com/v1/chat/completions',{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization':'Bearer '+ appApiKey
          },
          body:JSON.stringify(body)
        });
        const data=await res.json();
        
        if (res.ok && data.choices && data.choices[0] && data.choices[0].message) {
            const rawMd = data.choices[0].message.content.trim();
            responseBox.innerHTML = markdownToHtml(rawMd); // Convert and display
        } else if (data.error) {
            console.error('OpenAI API Error:', data.error);
            responseBox.innerHTML = `<p style="color:var(--danger-color);">Error: ${data.error.message}<br>(Code: ${data.error.code}, Type: ${data.error.type})</p>`;
             if (data.error.code === 'invalid_api_key' || data.error.type === 'auth_error') { // Added auth_error for broader check
                updateApiKeyStatus('Invalid API Key used for analysis. Please check and save it again.', 'error');
                appApiKey = '';
                localStorage.removeItem('interactionFinderApiKey');
                apiKeyInput.value = '';
            }
        } 
        else {
            console.error('Unexpected API response:', data);
            responseBox.innerHTML = '<p style="color:var(--danger-color);">An unexpected error occurred. No response or malformed response received.</p>';
        }

      }catch(e){
        console.error('Fetch Error:', e);
        responseBox.innerHTML = '<p style="color:var(--danger-color);">Request failed. Check your network connection or the console for more details.</p>';
      }finally{
        switchTo(sel('resultSection'));
      }
    }

    function toBase64(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=()=>resolve(reader.result.split(',')[1]);
        reader.onerror=error => reject(error);
        reader.readAsDataURL(file);
      });
    }

    // Initialize
    loadApiKeyFromStorage();
    switchTo(sel('captureSection'));
  </script>
</body>
</html>